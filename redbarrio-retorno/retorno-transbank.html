<!DOCTYPE html>
<html lang="es">
  <head>
    <meta charset="utf-8" />
    <title>Procesando pago...</title>
    <meta name="viewport" content="width=device-width, initial-scale=1" />
    <style>
      body { font-family: system-ui, sans-serif; text-align: center; margin-top: 4rem; color: #333; }
      .loader { border: 6px solid #f3f3f3; border-top: 6px solid #3b82f6; border-radius: 50%; width: 40px; height: 40px; animation: spin 1s linear infinite; margin: 1rem auto; }
      @keyframes spin { 0% { transform: rotate(0deg) } 100% { transform: rotate(360deg) } }
      .msg { margin-top: 1rem; font-size: 1.1rem; }
      .error { color: #e11d48; }
      .ok { color: #16a34a; }
      button { padding:10px 20px; border:none; background:#3b82f6; color:#fff; border-radius:6px; }
    </style>
  </head>
  <body>
    <div class="loader"></div>
    <h3 id="titulo">Procesando pago...</h3>
    <p class="msg" id="mensaje">Confirmando transacci√≥n con Transbank...</p>

    <p>
      <button id="btnVolver" style="display:none;">Volver a la app</button>
    </p>

    <script>
      (async () => {
        const urlParams = new URLSearchParams(window.location.search);
        const token_ws = urlParams.get("token_ws");

        const PKG = "io.ionic.starter"; // ‚¨ÖÔ∏è Reemplaza por tu applicationId real si difiere
        const DL_SCHEME = "redbarrio";
        const DL_HOST = "app";
        const DL_PATH = "/pago-retorno";

        const btn = document.getElementById("btnVolver");
        btn.onclick = () => {
          // Deep link manual desde bot√≥n
          const dl = `${DL_SCHEME}://${DL_HOST}${DL_PATH}?token_ws=${encodeURIComponent(token_ws || "")}`;
          window.location.href = dl;
        };

        function goDeepLink() {
          const dl = `${DL_SCHEME}://${DL_HOST}${DL_PATH}?token_ws=${encodeURIComponent(token_ws || "")}`;
          window.location.href = dl;
        }

        function goIntentFallback() {
          // Intent URI fallback (Android)
          const intent = `intent://${DL_HOST}${DL_PATH}?token_ws=${encodeURIComponent(token_ws || "")}#Intent;scheme=${DL_SCHEME};package=${PKG};end`;
          window.location.href = intent;
        }

        function showButton() {
          btn.style.display = "inline-block";
        }

        if (!token_ws) {
          document.getElementById("mensaje").innerText = "No se encontr√≥ token_ws.";
          document.getElementById("mensaje").className = "msg error";
          showButton();
          return;
        }

        try {
          const response = await fetch(
            "https://sovnabbbubapqxziubuh.supabase.co/functions/v1/transbank-confirm",
            {
              method: "POST",
              headers: { "Content-Type": "application/json" },
              body: JSON.stringify({ token_ws }),
            }
          );

          // Si la funci√≥n retorna 4xx/5xx, intenta parsear igual; si falla, lanza error
          let data = null;
          try { data = await response.json(); } catch(_) {}

          console.log("Respuesta confirm:", data);

          let estado = "rechazado";
          if (data?.status === "AUTHORIZED" || data?.estado === "pagado") {
            estado = "pagado";
          }

          document.getElementById("mensaje").innerText =
            estado === "pagado"
              ? "‚úÖ Pago realizado con √©xito. Redirigiendo a la app..."
              : "‚ùå Pago rechazado. Redirigiendo a la app...";
          document.getElementById("mensaje").className =
            estado === "pagado" ? "msg ok" : "msg error";

          // üîÅ Redirecci√≥n robusta:
          // 1) Intentar deep link nativo
          // 2) Si no abre, fallback a Intent URI
          // 3) Si aun as√≠ no abre, mostrar bot√≥n "Volver a la app"
          setTimeout(() => {
            goDeepLink();
            // Si el deep link no es manejado, este setTimeout se ejecutar√° igual:
            setTimeout(() => {
              goIntentFallback();
              // Si tampoco se maneja el Intent, ofrecer bot√≥n
              setTimeout(() => {
                showButton();
              }, 1500);
            }, 1200);
          }, 400);

        } catch (error) {
          console.error("Error confirmando:", error);
          document.getElementById("mensaje").innerText =
            "‚ö†Ô∏è Error al confirmar el pago. Puedes volver a la app y revisar el estado.";
          document.getElementById("mensaje").className = "msg error";
          showButton();
        }
      })();
    </script>
  </body>
</html>

