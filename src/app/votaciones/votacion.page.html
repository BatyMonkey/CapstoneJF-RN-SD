<ion-header class="rb-header">
  <ion-toolbar>
    <ion-buttons slot="start">
      <ion-menu-button menu="mainMenu" autoHide="false"></ion-menu-button>
    </ion-buttons>
    <ion-title>Votación</ion-title>
  </ion-toolbar>
</ion-header>

<ion-content class="ion-padding votacion" [fullscreen]="true">
  <!-- Pull-to-refresh -->
  <ion-refresher slot="fixed" (ionRefresh)="handleRefresh($event)">
    <ion-refresher-content
      pullingText="Desliza para refrescar"
      refreshingSpinner="crescent"
      refreshingText="Actualizando...">
    </ion-refresher-content>
  </ion-refresher>

  <ion-text color="danger" *ngIf="errorMsg" class="err">{{ errorMsg }}</ion-text>

  <div class="ion-text-center" *ngIf="cargando">
    <ion-spinner name="crescent"></ion-spinner>
  </div>

  <ng-container *ngIf="!cargando && votacion">
    <ion-card class="card">
      <ion-card-header>
        <ion-card-title>{{ votacion.titulo }}</ion-card-title>
        <ion-card-subtitle *ngIf="votacion.descripcion">
          {{ votacion.descripcion }}
        </ion-card-subtitle>
      </ion-card-header>

      <ion-card-content>
        <div class="status">
          <ion-chip [color]="bloqueada ? 'medium' : 'primary'" [outline]="true">
            <ion-icon name="time-outline"></ion-icon>
            <ion-label>{{ etiquetaTiempo() }}</ion-label>
          </ion-chip>

          <ion-badge color="tertiary" class="total" *ngIf="totalVotos">
            Total: {{ totalVotos }}
          </ion-badge>
        </div>

        <ion-list class="opciones" lines="none">
          <ion-item
            class="opcion"
            *ngFor="let op of opciones; trackBy: trackByOp"
            [class.seleccionada]="miOpcionId === op.id"
            [style.--pct]="pct(op)"
          >
            <ion-label class="label">
              <div class="top">
                <h2 class="titulo">{{ op.titulo }}</h2>
                <span class="pct-badge">{{ percent(op) }}%</span>
              </div>

              <p class="desc" *ngIf="op.descripcion" style="margin:4px 0 8px 0;">
                {{ op.descripcion }}
              </p>

              <div class="bar">
                <div class="fill"></div>
              </div>

              <!-- Imagen con tamaño uniforme + tap para ampliar -->
              <button
                class="img-box"
                *ngIf="op.image_url"
                type="button"
                (click)="openImage(op.image_url)"
                aria-label="Ver imagen en grande"
              >
                <img [src]="op.image_url" alt="Imagen opción" />
              </button>

              <p class="meta">Votos: {{ op.total_votos }}</p>
            </ion-label>

            <ion-button
              slot="end"
              [disabled]="!!miOpcionId || bloqueada"
              (click)="votar(op)"
            >
              {{ miOpcionId ? (miOpcionId === op.id ? 'Votado' : 'Votar') : 'Votar' }}
            </ion-button>
          </ion-item>
        </ion-list>

        <ion-note color="success" *ngIf="miOpcionId">¡Voto registrado!</ion-note>
      </ion-card-content>
    </ion-card>
  </ng-container>

  <!-- Modal visor de imagen -->
  <ion-modal [isOpen]="viewerOpen" (didDismiss)="closeViewer()">
    <ng-template>
      <ion-header translucent>
        <ion-toolbar>
          <ion-title>Imagen</ion-title>
          <ion-buttons slot="end">
            <ion-button (click)="closeViewer()">Cerrar</ion-button>
          </ion-buttons>
        </ion-toolbar>
      </ion-header>
      <ion-content [fullscreen]="true" class="viewer-content" (click)="closeViewer()">
        <img [src]="viewerUrl" alt="Imagen ampliada" />
      </ion-content>
    </ng-template>
  </ion-modal>

  <!-- Estilos inline -->
  <style>
    .img-box{
      margin-top:.5rem;
      width:100%;
      aspect-ratio:16/9;
      border-radius:8px;
      overflow:hidden;
      padding:0;
      border:none;
      background:#f3f4f6;
    }
    .img-box img{
      width:100%;
      height:100%;
      object-fit:cover;
      display:block;
    }
    .viewer-content{
      display:flex;
      align-items:center;
      justify-content:center;
      background:#000;
    }
    .viewer-content img{
      max-width:100vw;
      max-height:100vh;
      width:100%;
      height:auto;
      object-fit:contain;
      touch-action:pan-zoom;
    }
  </style>
</ion-content>
