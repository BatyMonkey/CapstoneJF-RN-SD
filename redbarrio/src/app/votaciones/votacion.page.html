<ion-header class="rb-header">
  <ion-toolbar>
    <ion-buttons slot="start">
      <ion-menu-button menu="mainMenu" autoHide="false"></ion-menu-button>
    </ion-buttons>
    <ion-title>Votación</ion-title>
  </ion-toolbar>
</ion-header>

<ion-content class="ion-padding votacion" [fullscreen]="true">
  <ion-refresher slot="fixed" (ionRefresh)="handleRefresh($event)">
    <ion-refresher-content
      pullingText="Desliza para refrescar"
      refreshingSpinner="crescent"
      refreshingText="Actualizando...">
    </ion-refresher-content>
  </ion-refresher>

  <ion-text color="danger" *ngIf="errorMsg" class="err">{{ errorMsg }}</ion-text>

  <div class="ion-text-center" *ngIf="cargando">
    <ion-spinner name="crescent"></ion-spinner>
  </div>

  <ng-container *ngIf="!cargando && votacion">
    <!-- Sub-header: Detalle de votación + estado -->
    <div class="detail-header">
      <span class="detail-title">Detalle de Votación</span>
      <span class="detail-status" [ngClass]="estadoChipClass()">
        {{ estadoChipLabel() }}
      </span>
    </div>

    <!-- Tarjeta principal -->
    <ion-card class="card">
      <ion-card-header>
        <div class="card-header-top">
          <div class="card-header-text">
            <ion-card-title>{{ votacion.titulo }}</ion-card-title>
            <ion-card-subtitle *ngIf="votacion.descripcion">
              {{ votacion.descripcion }}
            </ion-card-subtitle>
          </div>

          <!-- Pill “Votación” como en el listado -->
          <span class="type-badge">Votación</span>
        </div>
      </ion-card-header>

      <ion-card-content>
        <!-- Resumen participación / tiempo -->
        <div class="summary-row">
          <div class="summary-card">
            <div class="summary-icon participation">
              <ion-icon name="people-outline"></ion-icon>
            </div>
            <div class="summary-text">
              <span class="summary-label">Participación</span>
              <span class="summary-value">{{ totalVotos }} votos</span>
            </div>
          </div>

          <div class="summary-card">
            <div class="summary-icon time">
              <ion-icon name="time-outline"></ion-icon>
            </div>
            <div class="summary-text">
              <span class="summary-label">Tiempo restante</span>
              <span class="summary-value">{{ tiempoResumen() }}</span>
            </div>
          </div>
        </div>

        <h3 class="options-title">Opciones</h3>

        <!-- Lista de opciones -->
        <ion-list class="opciones" lines="none">
          <ion-item
            class="option-card"
            *ngFor="let op of opciones; trackBy: trackByOp"
            (click)="seleccionarOpcion(op)"
            [class.is-selected]="isOpcionSeleccionada(op)"
            [style.--pct]="pct(op)"
          >
            <!-- radio circle -->
            <div class="radio-wrap" slot="start">
              <span class="radio-outer">
                <span class="radio-inner" *ngIf="isOpcionSeleccionada(op)"></span>
              </span>
            </div>

            <ion-label class="option-label">
              <div class="option-top">
                <h2 class="option-title">{{ op.titulo }}</h2>
                <span class="pct-badge">{{ percent(op) }}%</span>
              </div>

              <p class="option-desc" *ngIf="op.descripcion">
                {{ op.descripcion }}
              </p>

              <!-- Imagen 16:9, se puede tap para ver detalle -->
              <button
                class="img-box"
                *ngIf="op.image_url"
                type="button"
                (click)="openDetail(op); $event.stopPropagation()"
                aria-label="Ver detalle de la opción"
              >
                <img [src]="op.image_url" alt="Imagen opción" />
              </button>

              <p class="option-meta">Votos: {{ op.total_votos || 0 }}</p>
            </ion-label>
          </ion-item>
        </ion-list>

        <ion-note color="success" *ngIf="miOpcionId">¡Voto registrado!</ion-note>
      </ion-card-content>
    </ion-card>

    <!-- Botón Confirmar voto -->
    <div class="confirm-footer">
      <ion-button
        expand="block"
        class="confirm-btn"
        [disabled]="!puedeConfirmar"
        (click)="confirmarVoto()"
      >
        <ion-icon slot="start" name="checkmark-circle-outline"></ion-icon>
        Confirmar voto
      </ion-button>
    </div>
  </ng-container>

  <!-- Modal detalle de imagen/opción (se mantiene) -->
  <ion-modal
    [isOpen]="detailOpen"
    (didDismiss)="closeDetail()"
    [backdropDismiss]="true"
    [showBackdrop]="true"
    cssClass="op-dialog"
  >
    <ng-template>
      <ng-container *ngIf="selectedOp as sop">
        <div class="dialog-overlay" (click)="closeDetail()">
          <ion-card class="dialog-card" (click)="$event.stopPropagation()">
            <div class="detail-img" *ngIf="sop.image_url">
              <img [src]="sop.image_url" alt="Imagen opción" />
            </div>

            <ion-card-header>
              <ion-card-title>{{ sop.titulo }}</ion-card-title>
              <ion-card-subtitle *ngIf="sop.descripcion">
                {{ sop.descripcion }}
              </ion-card-subtitle>
            </ion-card-header>

            <ion-card-content>
              <div class="detail-stats">
                <ion-badge color="primary">{{ percent(sop) }}%</ion-badge>
                <ion-badge color="medium">Votos: {{ sop.total_votos || 0 }}</ion-badge>
              </div>

              <div class="bar big">
                <div class="fill" [style.width.%]="percent(sop)"></div>
              </div>

              <ion-button
                expand="block"
                [disabled]="!!miOpcionId || bloqueada"
                (click)="votar(sop)"
              >
                {{ miOpcionId ? (miOpcionId === sop.id ? 'Votado' : 'Votar') : 'Votar' }}
              </ion-button>
            </ion-card-content>
          </ion-card>
        </div>
      </ng-container>
    </ng-template>
  </ion-modal>
</ion-content>
