<ion-header class="rb-header">
  <ion-toolbar>
    <ion-buttons slot="start">
      <ion-menu-button menu="mainMenu" autoHide="false"></ion-menu-button>
    </ion-buttons>
    <ion-title>Auditor√≠a del Sistema</ion-title>
  </ion-toolbar>
</ion-header>

<ion-content [fullscreen]="true" class="auditoria-content">
  <!-- üîÑ Refresher -->
  <ion-refresher slot="fixed" (ionRefresh)="cargarAuditoria($event)">
    <ion-refresher-content
      pullingText="Desliza para actualizar"
      refreshingSpinner="crescent"
      refreshingText="Actualizando..."
    ></ion-refresher-content>
  </ion-refresher>

  <!-- ‚úÖ Lista de registros -->
  <div class="list-container" *ngIf="!loading">
    <ion-card *ngFor="let item of registros" class="registro-card">
      <ion-card-header>
        <ion-card-title>{{ item.accion | titlecase }}</ion-card-title>

        <!-- üìÖ Fecha en hora local de Chile -->
        <ion-card-subtitle>
          {{ item.fecha | date:'dd/MM/yyyy HH:mm':'America/Santiago' }} ‚Äî {{ item.tabla }}
        </ion-card-subtitle>
      </ion-card-header>

      <ion-card-content>
        <p><strong>Usuario:</strong> {{ item.nombre || 'Desconocido' }}</p>

        <!-- üîç Detalle formateado -->
        <div class="detalle">
          <ng-container *ngFor="let key of orderedDetalleKeys(item.detalle)">
            <p [attr.key]="key">
              <strong>{{ (key + '') | titlecase }}:</strong>

              <!-- üß© Si es un array -->
              <ng-container *ngIf="isArray(item.detalle[key]); else notArray">
                <ul>
                  <li *ngFor="let op of item.detalle[key]">
                    <ng-container *ngIf="op.titulo; else rawObj">
                      {{ op.titulo }}
                      <span *ngIf="op.descripcion"> ‚Äì {{ op.descripcion }}</span>
                      <span *ngIf="op.image_url"> üì∑</span>
                    </ng-container>
                    <ng-template #rawObj>{{ op | json }}</ng-template>
                  </li>
                </ul>
              </ng-container>

              <!-- üß© Si NO es un array -->
              <ng-template #notArray>
                <!-- Si parece una fecha ISO -->
                <ng-container *ngIf="isFecha(item.detalle[key]); else otherType">
                  {{ item.detalle[key] | date:'dd/MM/yyyy HH:mm:ss':'America/Santiago' }}
                </ng-container>
                <ng-template #otherType>
                  <!-- Si es un objeto -->
                  <ng-container *ngIf="item.detalle[key] instanceof Object; else plain">
                    <pre>{{ item.detalle[key] | json }}</pre>
                  </ng-container>
                  <!-- Si es texto o n√∫mero -->
                  <ng-template #plain>
                    {{ item.detalle[key] }}
                  </ng-template>
                </ng-template>
              </ng-template>
            </p>
          </ng-container>
        </div>
      </ion-card-content>
    </ion-card>
  </div>

  <!-- üåÄ Cargando -->
  <div *ngIf="loading" class="loading">
    <ion-spinner name="crescent"></ion-spinner>
  </div>

  <!-- üö´ Sin registros -->
  <div class="empty" *ngIf="!loading && (!registros || !registros.length)">
    <ion-icon name="document-outline" color="medium" size="large"></ion-icon>
    <h2>No hay registros de auditor√≠a</h2>
    <p>Las acciones del sistema aparecer√°n aqu√≠ autom√°ticamente.</p>
  </div>
</ion-content>
