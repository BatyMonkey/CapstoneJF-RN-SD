<ion-content class="ion-padding" fullscreen>
  <div class="wrap">
    <ion-card>
      <ion-card-header>
        <ion-card-title color="primary">Registro de vecino</ion-card-title>
        <ion-card-subtitle>Completa tus datos</ion-card-subtitle>
      </ion-card-header>

      <ion-card-content>

        <!-- Botón OCR (ML Kit) -->
        <ion-button expand="block" fill="outline" (click)="scanCedula()" [disabled]="loading || scanning">
          <ion-icon slot="start" name="scan-outline"></ion-icon>
          {{ scanning ? 'Escaneando…' : 'Escanear cédula ' }}
        </ion-button>

        <ion-note *ngIf="scanning" color="medium" style="display:block;text-align:center;margin:6px 0 12px;">
          Mantén la cédula plana, con buena luz y sin reflejos.
        </ion-note>

        <!-- Uploader de boleta (mismo look que "Escanear cédula") -->
        <div style="margin-top:8px;"></div>

        <input
          #inpBoleta
          type="file"
          accept="image/*,application/pdf"
          hidden
          (change)="onBoletaPicked($event)"
        />

        <div class="boleta-uploader">
          <ion-button
            class="cta"
            expand="block"
            fill="outline"
            color="primary"
            (click)="triggerBoleta(inpBoleta)"
            [disabled]="loading">
            <ion-icon slot="start" name="cloud-upload-outline"></ion-icon>
            {{ boletaFile ? 'Cambiar boleta de servicios' : 'Subir boleta de servicios' }}
          </ion-button>

          <ion-text *ngIf="boletaFile">
            <small>{{ boletaFile?.name || '' }}</small>
          </ion-text>

          <!-- Eliminado el botón "Confirmar subida" -->
        </div>

        <ion-note color="medium" style="display:block;margin-top:6px;">
          Formatos: JPG/PNG o PDF. Se subirá automáticamente al registrarte.
        </ion-note>

        <form #f="ngForm" (ngSubmit)="register(f)" autocomplete="on" novalidate>

          <!-- Primer nombre -->
          <ion-item lines="none">
            <ion-icon name="person-outline" slot="start" color="primary"></ion-icon>
            <ion-input name="primer_nombre" [(ngModel)]="primer_nombre" placeholder="Primer nombre" required enterkeyhint="next" autocomplete="given-name" spellcheck="false" [disabled]="loading"></ion-input>
          </ion-item>
          <ion-note color="danger" *ngIf="f.submitted && !primer_nombre">Este campo es obligatorio.</ion-note>

          <!-- Segundo nombre -->
          <ion-item lines="none" style="margin-top:8px;">
            <ion-icon name="person-outline" slot="start" color="primary"></ion-icon>
            <ion-input name="segundo_nombre" [(ngModel)]="segundo_nombre" placeholder="Segundo nombre (opcional)" enterkeyhint="next" autocomplete="additional-name" spellcheck="false" [disabled]="loading"></ion-input>
          </ion-item>

          <!-- Primer apellido -->
          <ion-item lines="none" style="margin-top:8px;">
            <ion-icon name="person-outline" slot="start" color="primary"></ion-icon>
            <ion-input name="primer_apellido" [(ngModel)]="primer_apellido" placeholder="Primer apellido" required enterkeyhint="next" autocomplete="family-name" spellcheck="false" [disabled]="loading"></ion-input>
          </ion-item>
          <ion-note color="danger" *ngIf="f.submitted && !primer_apellido">Este campo es obligatorio.</ion-note>

          <!-- Segundo apellido -->
          <ion-item lines="none" style="margin-top:8px;">
            <ion-icon name="person-outline" slot="start" color="primary"></ion-icon>
            <ion-input name="segundo_apellido" [(ngModel)]="segundo_apellido" placeholder="Segundo apellido (opcional)" enterkeyhint="next" autocomplete="family-name" spellcheck="false" [disabled]="loading"></ion-input>
          </ion-item>

          <!-- RUT -->
          <ion-item lines="none" style="margin-top:10px;">
            <ion-icon name="card-outline" slot="start" color="primary"></ion-icon>
            <ion-input name="rut" [(ngModel)]="rut" placeholder="RUT (ej: 12.345.678-5)" required (ionBlur)="onRutBlur()" enterkeyhint="next" inputmode="text" maxlength="12" spellcheck="false" [disabled]="loading"></ion-input>
          </ion-item>
          <ion-note color="danger" *ngIf="f.submitted && !rut">Este campo es obligatorio.</ion-note>
          <ion-note color="danger" *ngIf="rut && rutInvalido">RUT inválido.</ion-note>

          <!-- Fecha de nacimiento -->
          <ion-item lines="none" style="margin-top:10px;">
            <ion-icon name="calendar-outline" slot="start" color="primary"></ion-icon>
            <ion-input
              type="date"
              name="fecha_nacimiento"
              [(ngModel)]="fecha_nacimiento"
              placeholder="Fecha de nacimiento"
              enterkeyhint="next"
              [disabled]="loading">
            </ion-input>
          </ion-item>

          <!-- Sexo -->
          <ion-item lines="none" style="margin-top:10px;">
            <ion-icon name="male-female-outline" slot="start" color="primary"></ion-icon>
            <ion-select
              interface="popover"
              name="sexo"
              [(ngModel)]="sexo"
              placeholder="Sexo"
              [disabled]="loading">
              <ion-select-option value="M">Masculino</ion-select-option>
              <ion-select-option value="F">Femenino</ion-select-option>
            </ion-select>
          </ion-item>

          <!-- Dirección -->
          <ion-item lines="none" style="margin-top:10px;">
            <ion-icon name="home-outline" slot="start" color="primary"></ion-icon>
            <ion-input name="direccion" [(ngModel)]="direccion" placeholder="Dirección" enterkeyhint="next" autocomplete="street-address" spellcheck="false" [disabled]="loading"></ion-input>
          </ion-item>

          <!-- Teléfono -->
          <ion-item lines="none" style="margin-top:10px;">
            <ion-icon name="call-outline" slot="start" color="primary"></ion-icon>
            <ion-input type="tel" name="telefono" [(ngModel)]="telefono" placeholder="Teléfono (+56 9XXXXXXXX)" required enterkeyhint="next" inputmode="tel" autocomplete="tel-national" maxlength="14" [disabled]="loading"></ion-input>
          </ion-item>
          <ion-note color="danger" *ngIf="f.submitted && !telefono">Campo obligatorio.</ion-note>
          <ion-note color="danger" *ngIf="telefono && !telefonoEsValido()">Formato inválido (Chile).</ion-note>

          <!-- Correo -->
          <ion-item lines="none" style="margin-top:10px;">
            <ion-icon name="mail-outline" slot="start" color="primary"></ion-icon>
            <ion-input type="email" name="email" [(ngModel)]="email" placeholder="Correo" required enterkeyhint="next" autocomplete="email" spellcheck="false" [disabled]="loading"></ion-input>
          </ion-item>
          <ion-note color="danger" *ngIf="f.submitted && !email">Campo obligatorio.</ion-note>

          <!-- Contraseña -->
          <ion-item lines="none" style="margin-top:10px;">
            <ion-icon name="lock-closed-outline" slot="start" color="primary"></ion-icon>
            <ion-input type="password" name="password" [(ngModel)]="password" placeholder="Contraseña (mínimo 6 caracteres)" required minlength="6" enterkeyhint="done" autocomplete="new-password" [disabled]="loading"></ion-input>
          </ion-item>
          <ion-note color="danger" *ngIf="f.submitted && (!password || password.length < 6)">Debe tener al menos 6 caracteres.</ion-note>

          <!-- Error general -->
          <ion-text color="danger" *ngIf="errorMsg" style="display:block;margin-top:8px;">{{ errorMsg }}</ion-text>

          <!-- Botón -->
          <ion-button type="submit" expand="block" size="large" color="primary" style="margin-top:16px;" [disabled]="loading">
            <ion-spinner slot="start" *ngIf="loading"></ion-spinner>
            {{ loading ? 'Creando…' : 'Registrarme' }}
          </ion-button>
        </form>
      </ion-card-content>
    </ion-card>
  </div>
</ion-content>
