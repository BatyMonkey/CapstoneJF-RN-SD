<ion-header class="rb-reg-header">
  <ion-toolbar>
    <ion-buttons slot="start">
      <ion-button
        fill="clear"
        class="back-btn"
        [routerLink]="['/auth/login']"
        routerDirection="back"
      >
        <ion-icon slot="icon-only" name="chevron-back-outline"></ion-icon>
      </ion-button>
    </ion-buttons>

    <div class="rb-reg-toolbar-text">
      <h1>Registro de vecino</h1>
      <p>Completa tus datos</p>
    </div>
  </ion-toolbar>
</ion-header>

<ion-content class="reg-content" fullscreen>
  <div class="reg-wrapper">
    <div class="reg-card">
      <!-- =============== TOP BOTONES =============== -->
      <div class="reg-actions">
        <!-- Escanear cédula -->
        <ion-button
          expand="block"
          fill="outline"
          class="reg-action-btn"
          (click)="scanCedula()"
          [disabled]="loading || scanning"
        >
          <ion-icon slot="start" name="scan-outline"></ion-icon>
          {{ scanning ? 'Escaneando…' : 'Escanear cédula' }}
        </ion-button>

        <!-- Subir boleta -->
        <input
          #inpBoleta
          type="file"
          accept="image/*,application/pdf"
          hidden
          (change)="onBoletaPicked($event)"
        />

        <ion-button
          expand="block"
          fill="outline"
          class="reg-action-btn"
          color="primary"
          (click)="triggerBoleta(inpBoleta)"
          [disabled]="loading"
        >
          <ion-icon slot="start" name="cloud-upload-outline"></ion-icon>
          {{ boletaFile ? 'Cambiar boleta de servicios' : 'Subir boleta de servicios' }}
        </ion-button>

        <ion-text *ngIf="boletaFile" class="reg-file-name">
          <small>{{ boletaFile?.name || '' }}</small>
        </ion-text>

        <ion-note *ngIf="scanning" color="medium" class="reg-note-center">
          Mantén la cédula plana, con buena luz y sin reflejos.
        </ion-note>

        <ion-note color="medium" class="reg-note-small">
          Formatos: JPG/PNG o PDF. Se subirá automáticamente al registrarte.
        </ion-note>
      </div>

      <!-- =============== FORMULARIO =============== -->
      <form
        #f="ngForm"
        (ngSubmit)="register(f)"
        autocomplete="on"
        novalidate
      >
        <!-- Primer nombre -->
        <ion-item lines="none" class="reg-input">
          <ion-icon name="person-outline" slot="start" color="primary"></ion-icon>
          <ion-input
            name="primer_nombre"
            [(ngModel)]="primer_nombre"
            placeholder="Primer nombre"
            required
            enterkeyhint="next"
            autocomplete="given-name"
            spellcheck="false"
            [disabled]="loading"
          ></ion-input>
        </ion-item>
        <ion-note color="danger" *ngIf="f.submitted && !primer_nombre" class="reg-error">
          Este campo es obligatorio.
        </ion-note>

        <!-- Segundo nombre -->
        <ion-item lines="none" class="reg-input">
          <ion-icon name="person-outline" slot="start" color="primary"></ion-icon>
          <ion-input
            name="segundo_nombre"
            [(ngModel)]="segundo_nombre"
            placeholder="Segundo nombre (opcional)"
            enterkeyhint="next"
            autocomplete="additional-name"
            spellcheck="false"
            [disabled]="loading"
          ></ion-input>
        </ion-item>

        <!-- Primer apellido -->
        <ion-item lines="none" class="reg-input">
          <ion-icon name="person-outline" slot="start" color="primary"></ion-icon>
          <ion-input
            name="primer_apellido"
            [(ngModel)]="primer_apellido"
            placeholder="Primer apellido"
            required
            enterkeyhint="next"
            autocomplete="family-name"
            spellcheck="false"
            [disabled]="loading"
          ></ion-input>
        </ion-item>
        <ion-note color="danger" *ngIf="f.submitted && !primer_apellido" class="reg-error">
          Este campo es obligatorio.
        </ion-note>

        <!-- Segundo apellido -->
        <ion-item lines="none" class="reg-input">
          <ion-icon name="person-outline" slot="start" color="primary"></ion-icon>
          <ion-input
            name="segundo_apellido"
            [(ngModel)]="segundo_apellido"
            placeholder="Segundo apellido (opcional)"
            enterkeyhint="next"
            autocomplete="family-name"
            spellcheck="false"
            [disabled]="loading"
          ></ion-input>
        </ion-item>

        <!-- RUT -->
        <ion-item lines="none" class="reg-input">
          <ion-icon name="card-outline" slot="start" color="primary"></ion-icon>
          <ion-input
            name="rut"
            [(ngModel)]="rut"
            placeholder="RUT (ej: 12.345.678-5)"
            required
            (ionBlur)="onRutBlur()"
            enterkeyhint="next"
            inputmode="text"
            maxlength="12"
            spellcheck="false"
            [disabled]="loading"
          ></ion-input>
        </ion-item>
        <ion-note color="danger" *ngIf="f.submitted && !rut" class="reg-error">
          Este campo es obligatorio.
        </ion-note>
        <ion-note color="danger" *ngIf="rut && rutInvalido" class="reg-error">
          RUT inválido.
        </ion-note>

        <!-- Fecha de nacimiento -->
        <ion-item lines="none" class="reg-input">
          <ion-icon name="calendar-outline" slot="start" color="primary"></ion-icon>
          <ion-input
            type="date"
            name="fecha_nacimiento"
            [(ngModel)]="fecha_nacimiento"
            placeholder="dd-mm-aaaa"
            enterkeyhint="next"
            [disabled]="loading"
          ></ion-input>
        </ion-item>

        <!-- Sexo -->
        <ion-item lines="none" class="reg-input">
          <ion-icon name="male-female-outline" slot="start" color="primary"></ion-icon>
          <ion-select
            interface="popover"
            name="sexo"
            [(ngModel)]="sexo"
            placeholder="Sexo"
            [disabled]="loading"
          >
            <ion-select-option value="M">Masculino</ion-select-option>
            <ion-select-option value="F">Femenino</ion-select-option>
          </ion-select>
        </ion-item>

        <!-- Dirección -->
        <ion-item lines="none" class="reg-input">
          <ion-icon name="home-outline" slot="start" color="primary"></ion-icon>
          <ion-input
            name="direccion"
            [(ngModel)]="direccion"
            placeholder="Dirección"
            enterkeyhint="next"
            autocomplete="street-address"
            spellcheck="false"
            [disabled]="loading"
          ></ion-input>
        </ion-item>

        <!-- Teléfono -->
        <ion-item lines="none" class="reg-input">
          <ion-icon name="call-outline" slot="start" color="primary"></ion-icon>
          <ion-input
            type="tel"
            name="telefono"
            [(ngModel)]="telefono"
            placeholder="Teléfono (+56 9XXXXXXXX)"
            required
            enterkeyhint="next"
            inputmode="tel"
            autocomplete="tel-national"
            maxlength="14"
            [disabled]="loading"
          ></ion-input>
        </ion-item>
        <ion-note color="danger" *ngIf="f.submitted && !telefono" class="reg-error">
          Campo obligatorio.
        </ion-note>
        <ion-note
          color="danger"
          *ngIf="telefono && !telefonoEsValido()"
          class="reg-error"
        >
          Formato inválido (Chile).
        </ion-note>

        <!-- Correo -->
        <ion-item lines="none" class="reg-input">
          <ion-icon name="mail-outline" slot="start" color="primary"></ion-icon>
          <ion-input
            type="email"
            name="email"
            [(ngModel)]="email"
            placeholder="Correo"
            required
            enterkeyhint="next"
            autocomplete="email"
            spellcheck="false"
            [disabled]="loading"
          ></ion-input>
        </ion-item>
        <ion-note color="danger" *ngIf="f.submitted && !email" class="reg-error">
          Campo obligatorio.
        </ion-note>

        <!-- Contraseña -->
        <ion-item lines="none" class="reg-input">
          <ion-icon name="lock-closed-outline" slot="start" color="primary"></ion-icon>
          <ion-input
            type="password"
            name="password"
            [(ngModel)]="password"
            placeholder="Contraseña (mínimo 6 caracteres)"
            required
            minlength="6"
            enterkeyhint="done"
            autocomplete="new-password"
            [disabled]="loading"
          ></ion-input>
        </ion-item>
        <ion-note
          color="danger"
          *ngIf="f.submitted && (!password || password.length < 6)"
          class="reg-error"
        >
          Debe tener al menos 6 caracteres.
        </ion-note>

        <!-- Error general -->
        <ion-text
          color="danger"
          *ngIf="errorMsg"
          class="reg-error"
        >
          {{ errorMsg }}
        </ion-text>

        <!-- Botón REGISTRARME -->
        <ion-button
          type="submit"
          expand="block"
          size="large"
          class="btn-register"
          [disabled]="loading"
        >
          <ion-spinner slot="start" *ngIf="loading"></ion-spinner>
          {{ loading ? 'Creando…' : 'Registrarme' }}
        </ion-button>
      </form>
    </div>
  </div>
</ion-content>
