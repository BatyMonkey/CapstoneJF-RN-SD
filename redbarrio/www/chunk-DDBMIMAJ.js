import{a as ge}from"./chunk-CATCBSYX.js";import{a as ue}from"./chunk-TX5AFJTF.js";import"./chunk-66QFWZLQ.js";import{A as l,C as E,D as I,Ea as z,Fa as X,Ga as Y,Ha as J,Ia as K,Ka as W,Na as Q,O as y,P as F,Ra as Z,S as T,Ua as ee,V as k,Va as te,W as N,Wa as oe,_ as U,a as O,ab as ie,ca as h,da as A,ea as R,fa as D,gb as ne,h as M,ha as f,hb as ae,i as s,ib as re,j as C,ja as $,k as w,kb as le,la as j,lb as ce,m as b,mb as se,o as p,oa as L,ob as de,p as a,q as t,r as u,ta as G,ua as B,ub as pe,v as P,vb as me,w as x,xa as V,ya as q,za as H}from"./chunk-H7HGEQUX.js";import"./chunk-G4GOZ2R2.js";import"./chunk-2GHFZAQB.js";import"./chunk-QUJFQN2Y.js";import"./chunk-VBARJE22.js";import"./chunk-6T3MRKSY.js";import"./chunk-LG5HFCS7.js";import"./chunk-PTM2QU7L.js";import"./chunk-Z7QLWI7J.js";import"./chunk-DNXVUVY2.js";import"./chunk-JS56SECH.js";import"./chunk-GFYYGWWH.js";import"./chunk-EXVGCGBZ.js";import"./chunk-IACAUHTZ.js";import"./chunk-WIVIOYVM.js";import"./chunk-ULQSOQCK.js";import"./chunk-JOPIHTUJ.js";import"./chunk-MTHZ7MWU.js";import"./chunk-WI5MSH4N.js";import"./chunk-EKNMT7ZB.js";import"./chunk-CKP3SGE2.js";import"./chunk-K6CL52MX.js";import{j as v}from"./chunk-VI73JOY6.js";function fe(n,d){n&1&&(a(0,"ion-note",25),l(1," El nombre es obligatorio. "),t())}function be(n,d){if(n&1&&(a(0,"ion-select-option",26),l(1),t()),n&2){let g=d.$implicit;p("value",g.id),s(),E(" ",g.nombre," ")}}function he(n,d){n&1&&(a(0,"ion-note",25),l(1," Debes seleccionar un tipo de espacio. "),t())}function _e(n,d){if(n&1&&(a(0,"div",27),u(1,"img",28),t()),n&2){let g=x();s(),p("src",g.imageUrl,M)}}function ve(n,d){n&1&&(a(0,"ion-note",25),l(1," La direcci\xF3n es obligatoria. "),t())}function Ce(n,d){if(n&1&&(a(0,"div",29)(1,"ion-note"),l(2),t()()),n&2){let g=x();s(2),I(" Latitud: ",g.latitud.value||"N/A",", Longitud: ",g.longitud.value||"N/A"," ")}}function xe(n,d){n&1&&u(0,"ion-spinner",30)}function Ee(n,d){if(n&1&&(a(0,"ion-card",25)(1,"ion-card-content"),l(2),t()()),n&2){let g=x();s(2),E("Error al guardar: ",g.error)}}var Se="sk.eyJ1IjoiYmF0eW1vbmtleSIsImEiOiJjbWdpYmltcGMwN2FoMmxweGtoYjNxajU5In0.2lE0EvGf4Onc4DhfytKERg",Pe="https://api.mapbox.com/geocoding/v5/mapbox.places/",Oe="Santiago, Chile",Me="-70.91,-33.72,-70.47,-33.25",Ge=(()=>{let d=class d{constructor(r,i,e,o){this.router=r,this.espaciosService=i,this.toastCtrl=e,this.http=o,this.isSaving=!1,this.error=null,this.selectedFile=null,this.imageUrl=null,this.supabase=ue,this.ubicacionSeleccionada=null,this.loading=!1,this.tiposEspacio=[],this.tiposEspacio=[{id:1,nombre:"Cancha"},{id:2,nombre:"Sede"},{id:3,nombre:"Parque"}],this.initForm()}ngOnInit(){return v(this,null,function*(){let{data:{user:r}}=yield this.supabase.auth.getUser();if(!r){yield this.mostrarToast("Debes iniciar sesi\xF3n para crear espacios","warning"),this.router.navigate(["/login"]);return}})}initForm(){this.espacioForm=new D({nombre:new f("",[h.required,h.maxLength(100)]),tipo:new f(1,[h.required]),capacidad:new f(null,[h.required,h.min(1)]),descripcion:new f(""),direccion_completa:new f("",[h.required,h.minLength(10)]),latitud:new f(null),longitud:new f(null),imagen_url:new f("")}),this.espacioForm.get("tipo")?.setValue(this.tiposEspacio[0].id)}get latitud(){return this.espacioForm.get("latitud")}get longitud(){return this.espacioForm.get("longitud")}seleccionarUbicacion(){alert("Funcionalidad de selecci\xF3n de mapa pendiente de implementar.")}obtenerCoordenadas(){return v(this,null,function*(){this.ubicacionSeleccionada=null,this.error=null;let r=this.espacioForm.get("direccion_completa")?.value;if(!r||r.trim().length<10)return this.error="La direcci\xF3n es muy corta.",!1;try{let i=`${r.trim()}, ${Oe}`,e=encodeURIComponent(i),o=`${Pe}${e}.json?bbox=${Me}&language=es&access_token=${Se}`,c=yield O(this.http.get(o));if(c&&c.features&&c.features.length>0){let[m,_]=c.features[0].center;return this.ubicacionSeleccionada={latitud:_,longitud:m},this.latitud.setValue(_),this.longitud.setValue(m),console.log("Mapbox encontr\xF3 coordenadas:",this.ubicacionSeleccionada),!0}else return this.error="Direcci\xF3n no encontrada. Intenta con m\xE1s detalles o una direcci\xF3n conocida.",yield this.mostrarToast(this.error,"warning"),!1}catch(i){return this.error="Error al conectar con la API de Mapbox. Revisa tu Access Token.",yield this.mostrarToast(this.error,"danger"),console.error("Error de Mapbox:",i),!1}})}onFileSelected(r){return v(this,null,function*(){let i=r.target.files[0];console.log("[onFileSelected] Archivo seleccionado:",i),i?(this.selectedFile=i,this.imageUrl=null,this.espacioForm.patchValue({imagen_url:""}),yield this.mostrarToast("Imagen lista para subir al guardar","primary")):(this.selectedFile=null,console.warn("[onFileSelected] No se seleccion\xF3 archivo."))})}uploadImageToSupabase(r){return v(this,null,function*(){try{let{data:{user:i}}=yield this.supabase.auth.getUser();if(!i)throw new Error("Usuario no autenticado");let e=r.name.split(".").pop(),o=`espacio_${Date.now()}_${Math.random().toString(36).slice(2)}.${e}`,c=`public/${i.id}/espacios/${o}`;console.log("[uploadImageToSupabase] Preparando para subir:",{fileExt:e,fileName:o,filePath:c,file:r});let{data:m,error:_}=yield this.supabase.storage.from("espacios-bucket").upload(c,r,{cacheControl:"3600",upsert:!1});if(console.log("[uploadImageToSupabase] Resultado de upload:",{data:m,error:_}),_)throw console.error("[uploadImageToSupabase] Error de Supabase al subir (Storage Error):",_.message),new Error(`Error Supabase: ${_.message||"Error desconocido al subir."}`);let{data:S}=this.supabase.storage.from("espacios-bucket").getPublicUrl(c);if(console.log("[uploadImageToSupabase] URL p\xFAblica obtenida:",S),!S.publicUrl)throw console.error("[uploadImageToSupabase] No se pudo obtener la URL p\xFAblica."),new Error("No se pudo obtener la URL p\xFAblica de la imagen.");return S.publicUrl}catch(i){throw console.error("[uploadImageToSupabase] Error grave de red/fetch. Revisa CORS/RLS/Token:",i.message||i),new Error(i.message||"Fallo de conexi\xF3n al servidor de Storage. Revisa el bucket y CORS.")}})}guardarEspacio(){return v(this,null,function*(){let{data:{user:r}}=yield this.supabase.auth.getUser();if(!r){this.error="Debes iniciar sesi\xF3n para crear espacios",yield this.mostrarToast(this.error,"warning"),this.router.navigate(["/login"]);return}if(this.espacioForm.markAllAsTouched(),this.espacioForm.invalid){this.error="Por favor, completa todos los campos obligatorios y corrige los errores.",this.mostrarToast(this.error,"danger");return}if(this.isSaving=!0,this.error=null,!(yield this.obtenerCoordenadas())||!this.ubicacionSeleccionada){this.isSaving=!1;return}let e="";if(this.selectedFile)try{let o=yield this.uploadImageToSupabase(this.selectedFile);if(!o){yield this.mostrarToast("No se pudo subir la imagen. Intenta de nuevo.","danger"),this.isSaving=!1;return}e=o}catch(o){console.error("Error al subir imagen en guardarEspacio:",o),yield this.mostrarToast(o.message||"Error al subir la imagen a Supabase.","danger"),this.isSaving=!1;return}try{let o={nombre:this.espacioForm.value.nombre,descripcion:this.espacioForm.value.descripcion,capacidad:this.espacioForm.value.capacidad,tipo:this.espacioForm.value.tipo,direccion_completa:this.espacioForm.value.direccion_completa,latitud:this.ubicacionSeleccionada.latitud,longitud:this.ubicacionSeleccionada.longitud,imagen_url:e||null};yield this.espaciosService.crearNuevoEspacio(o),yield this.mostrarToast("Espacio creado con \xE9xito!","success"),this.router.navigateByUrl("/espacios",{replaceUrl:!0})}catch(o){this.error=o.message||"Error al crear el espacio en la base de datos.",this.mostrarToast(this.error,"danger")}finally{this.isSaving=!1}})}mostrarToast(r,i){return v(this,null,function*(){(yield this.toastCtrl.create({message:r,duration:3e3,color:i})).present()})}};d.\u0275fac=function(i){return new(i||d)(C(U),C(ge),C(pe),C(k))},d.\u0275cmp=w({type:d,selectors:[["app-crear-espacio"]],decls:63,vars:13,consts:[[1,"rb-header",3,"translucent"],["slot","start"],["defaultHref","/espacios"],[3,"fullscreen"],[1,"page-wrap","ion-padding"],[3,"ngSubmit","formGroup"],[1,"card"],["lines","none",1,"field"],["position","stacked"],["type","text","formControlName","nombre","placeholder","Ej: Sal\xF3n Principal o Cancha #3"],["color","danger",4,"ngIf"],["formControlName","tipo","placeholder","Selecciona el tipo"],[3,"value",4,"ngFor","ngForOf"],["type","number","formControlName","capacidad","placeholder","Ej: 50"],["formControlName","descripcion","rows","4","placeholder","Descripci\xF3n detallada del espacio y sus caracter\xEDsticas."],["type","file","accept","image/*",1,"ion-padding-top",3,"change"],["class","ion-padding-top",4,"ngIf"],["type","text","formControlName","direccion_completa","placeholder","Calle, n\xFAmero, comuna"],["class","ion-padding-vertical ion-text-center",4,"ngIf"],["type","hidden","formControlName","latitud"],["type","hidden","formControlName","longitud"],[1,"actions"],["type","submit","color","success","size","large",3,"disabled"],["name","crescent",4,"ngIf"],[2,"height","50px"],["color","danger"],[3,"value"],[1,"ion-padding-top"],["alt","Preview",2,"max-width","100%","border-radius","8px",3,"src"],[1,"ion-padding-vertical","ion-text-center"],["name","crescent"]],template:function(i,e){if(i&1&&(a(0,"ion-header",0)(1,"ion-toolbar")(2,"ion-buttons",1),u(3,"ion-back-button",2),t(),a(4,"ion-title"),l(5,"Crear Nuevo Espacio"),t()()(),a(6,"ion-content",3)(7,"div",4)(8,"form",5),P("ngSubmit",function(){return e.guardarEspacio()}),a(9,"ion-card",6)(10,"ion-card-header")(11,"ion-card-title"),l(12,"Detalles del Espacio"),t()(),a(13,"ion-card-content")(14,"ion-item",7)(15,"ion-label",8),l(16,"Nombre (*)"),t(),u(17,"ion-input",9),t(),b(18,fe,2,0,"ion-note",10),a(19,"ion-item",7)(20,"ion-label",8),l(21,"Tipo de Espacio (*)"),t(),a(22,"ion-select",11),l(23," Tipo de Espacio "),b(24,be,2,2,"ion-select-option",12),t()(),b(25,he,2,0,"ion-note",10),a(26,"ion-item",7)(27,"ion-label",8),l(28,"Capacidad (Personas)"),t(),u(29,"ion-input",13),t(),a(30,"ion-item",7)(31,"ion-label",8),l(32,"Descripci\xF3n"),t(),u(33,"ion-textarea",14),t()()(),a(34,"ion-card",6)(35,"ion-card-header")(36,"ion-card-title"),l(37,"Imagen del Espacio"),t()(),a(38,"ion-card-content")(39,"ion-item",7)(40,"ion-label",8),l(41,"Imagen"),t(),a(42,"input",15),P("change",function(c){return e.onFileSelected(c)}),t()(),b(43,_e,2,1,"div",16),t()(),a(44,"ion-card",6)(45,"ion-card-header")(46,"ion-card-title"),l(47,"Ubicaci\xF3n"),t()(),a(48,"ion-card-content")(49,"ion-item",7)(50,"ion-label",8),l(51,"Direcci\xF3n Completa (*)"),t(),u(52,"ion-input",17),t(),b(53,ve,2,0,"ion-note",10)(54,Ce,3,2,"div",18),u(55,"ion-input",19)(56,"ion-input",20),t()(),a(57,"div",21)(58,"ion-button",22),b(59,xe,1,0,"ion-spinner",23),l(60),t()(),u(61,"div",24),t(),b(62,Ee,3,1,"ion-card",10),t()()),i&2){let o,c,m;p("translucent",!0),s(6),p("fullscreen",!0),s(2),p("formGroup",e.espacioForm),s(10),p("ngIf",((o=e.espacioForm.get("nombre"))==null?null:o.invalid)&&(((o=e.espacioForm.get("nombre"))==null?null:o.dirty)||((o=e.espacioForm.get("nombre"))==null?null:o.touched))),s(6),p("ngForOf",e.tiposEspacio),s(),p("ngIf",((c=e.espacioForm.get("tipo"))==null?null:c.invalid)&&(((c=e.espacioForm.get("tipo"))==null?null:c.dirty)||((c=e.espacioForm.get("tipo"))==null?null:c.touched))),s(18),p("ngIf",e.imageUrl),s(10),p("ngIf",((m=e.espacioForm.get("direccion_completa"))==null?null:m.invalid)&&(((m=e.espacioForm.get("direccion_completa"))==null?null:m.dirty)||((m=e.espacioForm.get("direccion_completa"))==null?null:m.touched))),s(),p("ngIf",e.latitud.value||e.longitud.value),s(4),p("disabled",e.espacioForm.invalid||e.isSaving),s(),p("ngIf",e.isSaving),s(),E(" ",e.isSaving?"Guardando...":"Guardar Espacio"," "),s(2),p("ngIf",e.error)}},dependencies:[me,z,X,Y,J,K,W,Q,Z,ee,te,oe,ie,ne,ae,re,le,ce,se,V,q,H,de,T,y,F,G,$,A,R,B,j,L,N],styles:['@charset "UTF-8";[_nghost-%COMP%], html[_nghost-%COMP%], html   [_nghost-%COMP%]{color-scheme:light!important;--rb-primary: #2563eb;--rb-bg: #f5f7fb;--rb-text: #0f172a;--rb-muted: #475569;--ion-text-color: var(--rb-text);--ion-background-color: var(--rb-bg);--ion-item-background: #ffffff;--ion-card-background: #ffffff}.rb-header[_ngcontent-%COMP%]   ion-toolbar[_ngcontent-%COMP%]{--background: linear-gradient(135deg, var(--rb-primary), #60a5fa);--color: #fff;--border-color: transparent}.page-wrap[_ngcontent-%COMP%]{max-width:960px;margin:0 auto}ion-card.card[_ngcontent-%COMP%]{background:#fff;border-radius:18px;border:1px solid rgba(2,6,23,.08);box-shadow:0 12px 28px #0206171a;overflow:hidden;margin-bottom:20px}ion-card.card[_ngcontent-%COMP%]   ion-card-header[_ngcontent-%COMP%]{background:#fff;border-bottom:1px solid rgba(2,6,23,.06);padding-bottom:8px}ion-card.card[_ngcontent-%COMP%]   ion-card-title[_ngcontent-%COMP%]{color:var(--rb-text);font-weight:800;font-size:1.3rem}ion-card.card[_ngcontent-%COMP%]   ion-card-subtitle[_ngcontent-%COMP%]{color:#64748b;font-weight:600;margin-top:4px;font-size:.9rem}.field[_ngcontent-%COMP%]{margin:14px 0;border-radius:14px;background:#fff;border:1.5px solid #e2e8f0;box-shadow:0 6px 16px #0206170f;--background: #fff;--inner-background: #fff;--min-height: auto;--padding-start: 12px;--inner-padding-end: 12px;--inner-padding-top: 12px;--inner-padding-bottom: 12px}.field[_ngcontent-%COMP%]   ion-label[_ngcontent-%COMP%]{color:var(--rb-muted);font-weight:700;padding:0;margin:4px 4px 6px 2px;display:block}.field[_ngcontent-%COMP%]   ion-input[_ngcontent-%COMP%], .field[_ngcontent-%COMP%]   ion-textarea[_ngcontent-%COMP%], .field[_ngcontent-%COMP%]   ion-select[_ngcontent-%COMP%]{--background: #fff;--color: var(--rb-text);--placeholder-color: #94a3b8;--padding-end: 10px;--padding-top: 8px;--padding-bottom: 10px;--highlight-color-focused: var(--rb-primary);font-weight:600}.field[_ngcontent-%COMP%]   ion-select[_ngcontent-%COMP%]{font-weight:600;color:var(--rb-text)}.field[_ngcontent-%COMP%]   ion-textarea[_ngcontent-%COMP%]{min-height:110px}.field[_ngcontent-%COMP%]:hover{border-color:#cbd5e1}.field[_ngcontent-%COMP%]:focus-within{border-color:var(--rb-primary);box-shadow:0 0 0 3px #2563eb24}.field.invalid[_ngcontent-%COMP%]{border-color:#ef44448c;box-shadow:0 0 0 3px #ef444424}ion-note[_ngcontent-%COMP%]{display:block;margin:4px 6px 0 8px;font-size:.86rem;color:var(--rb-muted)}.actions[_ngcontent-%COMP%]{margin-top:24px;padding-bottom:24px;display:flex;gap:10px;justify-content:flex-end}.actions[_ngcontent-%COMP%]   ion-button[_ngcontent-%COMP%]{border-radius:12px;font-weight:700;box-shadow:0 10px 18px #2563eb26}.actions[_ngcontent-%COMP%]   ion-button[_ngcontent-%COMP%]:active{transform:translateY(1px);box-shadow:0 6px 14px #2563eb1a}@media (prefers-color-scheme: dark){[_nghost-%COMP%]{--ion-background-color: var(--rb-bg);--ion-card-background: #ffffff;--ion-item-background: #ffffff;--ion-text-color: var(--rb-text)}.field[_ngcontent-%COMP%]{border-color:#e2e8f0}}[_ngcontent-%COMP%]:root{--rb-primary: #2563eb;--rb-text: #0f172a}.alert-md[_ngcontent-%COMP%]{--background: #ffffff !important;--color: var(--rb-text) !important}.alert-md[_ngcontent-%COMP%]   .alert-wrapper[_ngcontent-%COMP%]{background:#fff!important}.alert-md[_ngcontent-%COMP%]   .alert-radio-label[_ngcontent-%COMP%]{color:var(--rb-text)!important}.alert-md[_ngcontent-%COMP%]   .alert-button[_ngcontent-%COMP%]{color:var(--rb-primary)!important;font-weight:600}.alert-md[_ngcontent-%COMP%]   .alert-radio-icon[_ngcontent-%COMP%]{border-color:#cbd5e1!important}.alert-md[_ngcontent-%COMP%]   .alert-radio-icon.alert-radio-checked[_ngcontent-%COMP%]{border-color:var(--rb-primary)!important}.alert-md[_ngcontent-%COMP%]   .alert-radio-inner[_ngcontent-%COMP%]{background:var(--rb-primary)!important}']});let n=d;return n})();export{Ge as CrearEspacioPage};
