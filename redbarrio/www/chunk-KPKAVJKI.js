import{b as d,ib as l,jb as p}from"./chunk-C6RY7PX2.js";import{j as u}from"./chunk-VI73JOY6.js";var v=(()=>{let i=class i{constructor(){this.supabase=l(p.supabaseUrl,p.supabaseAnonKey)}obtenerVotacionConOpciones(o){return u(this,null,function*(){let[{data:t,error:e},{data:s,error:a}]=yield Promise.all([this.supabase.from("votaciones").select("*").eq("id",o).single(),this.supabase.from("opciones_votacion_conteo").select("*").eq("votacion_id",o).order("titulo",{ascending:!0})]);if(e)throw e;if(a)throw a;let r,{data:n}=yield this.supabase.auth.getUser();if(n.user){let{data:c}=yield this.supabase.from("votos").select("opcion_id").eq("votacion_id",o).eq("usuario_id",n.user.id).maybeSingle();c&&(r=c.opcion_id)}return{votacion:t,opciones:s??[],miOpcionId:r}})}votar(o,t){return u(this,null,function*(){let{data:e}=yield this.supabase.auth.getUser();if(!e.user)throw new Error("Debes iniciar sesi\xF3n para votar");let{error:s}=yield this.supabase.from("votos").insert({votacion_id:o,opcion_id:t,usuario_id:e.user.id});if(s)throw s})}suscribirVotosInsertados(o,t){return this.supabase.channel(`votos-insert-${o}`).on("postgres_changes",{event:"INSERT",schema:"public",table:"votos",filter:`votacion_id=eq.${o}`},e=>t(e)).subscribe()}desuscribir(o){this.supabase.removeChannel(o)}listarVotacionesActivas(){return u(this,null,function*(){let o=new Date().toISOString(),{data:t,error:e}=yield this.supabase.from("votaciones").select("*").lte("fecha_inicio",o).gte("fecha_fin",o).order("fecha_fin",{ascending:!0});if(e)throw e;return t??[]})}crearVotacionConOpciones(o){return u(this,null,function*(){let{data:{user:t},error:e}=yield this.supabase.auth.getUser();if(e)throw e;if(!t)throw new Error("Debes iniciar sesi\xF3n");let{data:s,error:a}=yield this.supabase.from("votaciones").insert([{titulo:o.titulo,descripcion:o.descripcion??null,fecha_inicio:o.fecha_inicio,fecha_fin:o.fecha_fin,creado_por:t.id}]).select("id").single();if(a)throw a;let r=s.id,n=o.opciones.map(f=>f.trim()).filter(Boolean);if(n.length<2)throw new Error("Agrega al menos dos opciones");let{error:c}=yield this.supabase.from("opciones_votacion").insert(n.map(f=>({votacion_id:r,titulo:f})));if(c)throw c;return r})}};i.\u0275fac=function(t){return new(t||i)},i.\u0275prov=d({token:i,factory:i.\u0275fac,providedIn:"root"});let h=i;return h})();export{v as a};
