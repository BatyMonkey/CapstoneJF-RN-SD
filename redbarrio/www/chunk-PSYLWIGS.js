import{a as be}from"./chunk-CATCBSYX.js";import{a as ge}from"./chunk-GC4IB6VA.js";import{a as fe}from"./chunk-CL4KBMSP.js";import"./chunk-SIZNMXVG.js";import{a as _}from"./chunk-TX5AFJTF.js";import{a as ue}from"./chunk-66QFWZLQ.js";import{A as n,D as M,Ea as $,Fa as U,Ga as V,Ha as H,Ia as L,Ja as z,Ka as J,Na as K,O as P,Oa as Q,P as y,Ra as W,S as D,Ua as X,Va as Y,Wa as Z,_ as F,_a as ee,ab as te,bb as ie,ca as g,cb as oe,da as T,ea as N,gb as ne,hb as re,i as m,j as l,ja as k,k as w,kb as ae,la as R,lb as se,m as x,mb as ce,o as u,oa as j,p as i,q as e,r as d,rb as le,sa as A,sb as de,ua as B,ub as pe,v as S,vb as me,ya as q,za as G}from"./chunk-H7HGEQUX.js";import"./chunk-G4GOZ2R2.js";import"./chunk-2GHFZAQB.js";import"./chunk-QUJFQN2Y.js";import"./chunk-VBARJE22.js";import"./chunk-6T3MRKSY.js";import"./chunk-LG5HFCS7.js";import"./chunk-PTM2QU7L.js";import"./chunk-Z7QLWI7J.js";import"./chunk-DNXVUVY2.js";import"./chunk-JS56SECH.js";import"./chunk-GFYYGWWH.js";import"./chunk-EXVGCGBZ.js";import"./chunk-IACAUHTZ.js";import"./chunk-WIVIOYVM.js";import"./chunk-ULQSOQCK.js";import"./chunk-JOPIHTUJ.js";import"./chunk-MTHZ7MWU.js";import"./chunk-WI5MSH4N.js";import"./chunk-EKNMT7ZB.js";import"./chunk-CKP3SGE2.js";import"./chunk-K6CL52MX.js";import{j as f}from"./chunk-VI73JOY6.js";function he(s,a){if(s&1&&(i(0,"ion-select-option",21),n(1),e()),s&2){let C=a.$implicit;u("value",C.id_espacio),m(),M(" ",C.nombre," \u2014 ",C.tipo||"General"," ")}}function _e(s,a){s&1&&(i(0,"ion-note",22),n(1," No hay espacios disponibles por ahora. "),e())}var ke=(()=>{let a=class a{constructor(t,r,o,p,c,v,b){this.fb=t,this.espaciosService=r,this.authService=o,this.alertCtrl=p,this.toastCtrl=c,this.loadingCtrl=v,this.router=b,this.espaciosDisponibles=[],this.solicitudForm=this.fb.group({id_espacio:["",g.required],descripcion:[""],evento_titulo:["",g.required],evento_descripcion:["",g.required],evento_inicio:["",g.required],evento_fin:["",g.required]})}ngOnInit(){return f(this,null,function*(){yield this.cargarEspaciosDisponibles()})}cargarEspaciosDisponibles(){return f(this,null,function*(){try{let t=yield this.espaciosService.obtenerEspacios();this.espaciosDisponibles=t||[]}catch(t){console.error("Error cargando espacios:",t),this.espaciosDisponibles=[]}})}enviarSolicitud(){return f(this,null,function*(){if(this.solicitudForm.invalid)return;let t=this.solicitudForm.value,o=(yield this.authService.session())?.user?.id||null;if(!o){this.mostrarAlerta("Error","No se pudo obtener el usuario autenticado.");return}let p=yield this.loadingCtrl.create({message:"Procesando solicitud...",spinner:"crescent"});yield p.present();try{let{data:c,error:v}=yield _.from("evento").insert([{titulo:t.evento_titulo,descripcion:t.evento_descripcion,fecha_inicio:t.evento_inicio,fecha_fin:t.evento_fin}]).select().single();if(v)throw v;let b=Number(t.id_espacio),{data:ve,error:E}=yield _.from("reserva").insert([{id_espacio:b,id_evento:c.id_evento,id_auth:o,fecha:new Date().toISOString(),creado_en:new Date().toISOString()}]).select().single();if(E)throw E;let{data:Ce,error:I}=yield _.from("orden_pago").insert([{id_auth:o,id_evento:c.id_evento,id_espacio:b,monto:1500,estado:"pendiente",created_at:new Date().toISOString(),updated_at:new Date().toISOString()}]).select().single();if(I)throw I;let O=yield fetch(`${ue.supabaseUrl}/functions/v1/transbank-simular`,{method:"POST",headers:{"Content-Type":"application/json"},body:JSON.stringify({id_reserva:ve.id_reserva,monto:1500,descripcion:`Pago arriendo espacio #${b}`})});if(!O.ok)throw new Error("Error al iniciar simulaci\xF3n de pago");let h=yield O.json();if(h.url&&h.token)yield ge.open({url:`${h.url}?token_ws=${h.token}`,presentationStyle:"fullscreen"});else throw new Error("No se recibi\xF3 token o URL de Transbank.");yield p.dismiss()}catch(c){console.error("Error al enviar solicitud:",c),yield p.dismiss(),this.mostrarAlerta("Error","No se pudo completar la reserva ni el pago.")}})}mostrarAlerta(t,r){return f(this,null,function*(){yield(yield this.alertCtrl.create({header:t,message:r,buttons:["OK"]})).present()})}mostrarToast(t){return f(this,null,function*(){(yield this.toastCtrl.create({message:t,duration:2500,color:"success"})).present()})}};a.\u0275fac=function(r){return new(r||a)(l(A),l(be),l(fe),l(le),l(pe),l(de),l(F))},a.\u0275cmp=w({type:a,selectors:[["app-solicitud"]],decls:47,vars:5,consts:[[1,"rb-header"],["slot","start"],["menu","mainMenu","autoHide","false"],[1,"ion-padding","reserva",3,"fullscreen"],["slot","fixed",3,"ionRefresh"],["pullingText","Desliza para refrescar","refreshingSpinner","crescent","refreshingText","Actualizando..."],[1,"card"],[3,"ngSubmit","formGroup"],[1,"field"],["position","stacked"],["formControlName","id_espacio","interface","popover","placeholder","Elige un espacio disponible"],[3,"value",4,"ngFor","ngForOf"],["color","medium",4,"ngIf"],["formControlName","descripcion","placeholder","Agrega una nota o detalle (opcional)"],["formControlName","evento_titulo","placeholder","Ej: Campeonato de f\xFAtbol"],["formControlName","evento_descripcion","placeholder","Describe el evento"],[1,"grid-2"],["formControlName","evento_inicio","presentation","date-time","minute-values","0,15,30,45"],["formControlName","evento_fin","presentation","date-time","minute-values","0,15,30,45"],[1,"actions"],["expand","block","type","submit","color","success",3,"disabled"],[3,"value"],["color","medium"]],template:function(r,o){r&1&&(i(0,"ion-header",0)(1,"ion-toolbar")(2,"ion-buttons",1),d(3,"ion-menu-button",2),e(),i(4,"ion-title"),n(5,"Reserva de Espacio/Terreno"),e()()(),i(6,"ion-content",3)(7,"ion-refresher",4),S("ionRefresh",function(c){return o.cargarEspaciosDisponibles(),c.target.complete()}),d(8,"ion-refresher-content",5),e(),i(9,"ion-card",6)(10,"ion-card-header")(11,"ion-card-title"),n(12,"Formulario de Reserva"),e(),i(13,"ion-card-subtitle"),n(14,"Completa los datos para solicitar un espacio"),e()(),i(15,"ion-card-content")(16,"form",7),S("ngSubmit",function(){return o.enviarSolicitud()}),i(17,"ion-item",8)(18,"ion-label",9),n(19,"Selecciona un Espacio"),e(),i(20,"ion-select",10),x(21,he,2,3,"ion-select-option",11),e()(),x(22,_e,2,0,"ion-note",12),i(23,"ion-item",8)(24,"ion-label",9),n(25,"Descripci\xF3n / Comentario"),e(),d(26,"ion-textarea",13),e(),i(27,"ion-item",8)(28,"ion-label",9),n(29,"T\xEDtulo del Evento"),e(),d(30,"ion-input",14),e(),i(31,"ion-item",8)(32,"ion-label",9),n(33,"Descripci\xF3n del Evento"),e(),d(34,"ion-textarea",15),e(),i(35,"div",16)(36,"ion-item",8)(37,"ion-label",9),n(38,"Fecha de Inicio"),e(),d(39,"ion-datetime",17),e(),i(40,"ion-item",8)(41,"ion-label",9),n(42,"Fecha de T\xE9rmino"),e(),d(43,"ion-datetime",18),e()(),i(44,"div",19)(45,"ion-button",20),n(46," \u{1F4B3} Reservar Espacio "),e()()()()()()),r&2&&(m(6),u("fullscreen",!0),m(10),u("formGroup",o.solicitudForm),m(5),u("ngForOf",o.espaciosDisponibles),m(),u("ngIf",(o.espaciosDisponibles==null?null:o.espaciosDisponibles.length)===0),m(23),u("disabled",o.solicitudForm.invalid))},dependencies:[D,P,y,me,$,U,V,H,L,z,J,K,Q,W,X,Y,Z,ee,te,ie,oe,ne,re,ae,se,ce,q,G,B,k,T,N,R,j],styles:['@charset "UTF-8";[_nghost-%COMP%]{color-scheme:light;--rb-primary: #2563eb;--rb-primary-10: rgba(37, 99, 235, .1);--rb-primary-20: rgba(37, 99, 235, .2);--rb-bg: #f8fafc;--rb-text: #0f172a;--ion-background-color: var(--rb-bg);--ion-text-color: var(--rb-text)}.rb-header[_ngcontent-%COMP%]   ion-toolbar[_ngcontent-%COMP%]{--background: linear-gradient(135deg, var(--rb-primary), #60a5fa);--color: #fff;--border-color: transparent}ion-card.card[_ngcontent-%COMP%]{background:#fff;border-radius:18px;border:1px solid rgba(2,6,23,.06);box-shadow:0 10px 26px #02061714;overflow:hidden}ion-card.card[_ngcontent-%COMP%]   ion-card-header[_ngcontent-%COMP%]{background:#fff;border-bottom:1px solid rgba(2,6,23,.06)}ion-card.card[_ngcontent-%COMP%]   ion-card-header[_ngcontent-%COMP%]   ion-card-title[_ngcontent-%COMP%]{font-weight:800;color:var(--rb-text)}ion-card.card[_ngcontent-%COMP%]   ion-card-header[_ngcontent-%COMP%]   ion-card-subtitle[_ngcontent-%COMP%]{color:#64748b;font-weight:500}ion-card.card[_ngcontent-%COMP%]   ion-card-content[_ngcontent-%COMP%]{padding-top:12px}ion-card.card[_ngcontent-%COMP%]   ion-card-content[_ngcontent-%COMP%]   ion-chip[_ngcontent-%COMP%]{margin-bottom:8px;--color: var(--rb-text);--background: var(--rb-primary-10);--border-color: var(--rb-primary-20)}.field[_ngcontent-%COMP%]{--background: #fff;background:#fff;border-radius:14px;margin:10px 6px;border:1px solid rgba(2,6,23,.06);box-shadow:0 6px 14px #0206170f}.field[_ngcontent-%COMP%]   ion-label[_ngcontent-%COMP%]{font-weight:700;color:var(--rb-text)}.grid-2[_ngcontent-%COMP%]{display:grid;gap:10px;grid-template-columns:1fr}@media (min-width: 640px){.grid-2[_ngcontent-%COMP%]{grid-template-columns:1fr 1fr}}.actions[_ngcontent-%COMP%]{margin-top:12px;padding:0 6px}.actions[_ngcontent-%COMP%]   ion-button[_ngcontent-%COMP%]{border-radius:12px;box-shadow:0 10px 18px var(--rb-primary-10);--padding-start: 14px;--padding-end: 14px}.ios[_ngcontent-%COMP%]   .field[_ngcontent-%COMP%]{--padding-start: 12px;--inner-padding-end: 12px}']});let s=a;return s})();export{ke as SolicitudPage};
