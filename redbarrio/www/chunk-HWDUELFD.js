import{a as ae}from"./chunk-CL4KBMSP.js";import{a as h}from"./chunk-TX5AFJTF.js";import"./chunk-66QFWZLQ.js";import{A as s,C as F,Ea as z,Fa as D,Ga as G,Ha as H,Ia as L,Ja as $,Ka as Y,Na as K,P as I,Ra as q,S as E,Sa as J,Ua as Q,Va as W,_ as A,ca as k,da as T,ea as U,f as _,g as b,h as v,i as o,ib as Z,j as P,ja as N,jb as ee,k as y,la as V,lb as te,m as g,mb as ne,o as r,oa as X,ob as ie,p as i,q as a,r as p,sa as j,u as x,ua as B,ub as oe,v as C,vb as re,w as S,x as w,za as R}from"./chunk-H7HGEQUX.js";import"./chunk-G4GOZ2R2.js";import"./chunk-2GHFZAQB.js";import"./chunk-QUJFQN2Y.js";import"./chunk-VBARJE22.js";import"./chunk-6T3MRKSY.js";import"./chunk-LG5HFCS7.js";import"./chunk-PTM2QU7L.js";import"./chunk-Z7QLWI7J.js";import"./chunk-DNXVUVY2.js";import"./chunk-JS56SECH.js";import"./chunk-GFYYGWWH.js";import"./chunk-EXVGCGBZ.js";import"./chunk-IACAUHTZ.js";import"./chunk-WIVIOYVM.js";import"./chunk-ULQSOQCK.js";import"./chunk-JOPIHTUJ.js";import"./chunk-MTHZ7MWU.js";import"./chunk-WI5MSH4N.js";import"./chunk-EKNMT7ZB.js";import"./chunk-CKP3SGE2.js";import"./chunk-K6CL52MX.js";import{j as f}from"./chunk-VI73JOY6.js";function le(c,d){c&1&&p(0,"ion-spinner",32)}function ce(c,d){c&1&&(i(0,"div",33),s(1," Tu cuenta a\xFAn no ha sido verificada. "),a())}function pe(c,d){c&1&&(i(0,"p"),s(1," El formato de tel\xE9fono debe ser: **(+56) 9XXXXXXXX** (ej: +56912345678 o 912345678). "),a())}function de(c,d){if(c&1&&(i(0,"ion-text",34),g(1,pe,2,0,"p",30),a()),c&2){let O,n=S();o(),r("ngIf",(O=n.perfilForm.get("telefono"))==null||O.errors==null?null:O.errors.pattern)}}function se(c,d){c&1&&(i(0,"span"),s(1,"Guardar Cambios"),a())}function fe(c,d){c&1&&(i(0,"span"),s(1,"Guardando..."),a())}function ge(c,d){c&1&&p(0,"ion-spinner",32)}var M="perfiles-bucket",ue=/^(\+?56)?\s?9\d{8}$/,xe=(()=>{let d=class d{constructor(n,t,e,l){this.fb=n,this.authService=t,this.toastController=e,this.router=l,this.perfilActual=null,this.isLoading=!1,this.isSaving=!1,this.usuarioActual=null,this.fotoFile=null,this.isUploading=!1,this.perfilForm=this.fb.group({nombre:[{value:"",disabled:!0}],correo:[{value:"",disabled:!0}],rut:[{value:"",disabled:!0}],direccion:[{value:"",disabled:!0}],primer_apellido:[{value:"",disabled:!0}],segundo_nombre:[null],telefono:[null,[k.pattern(ue)]],segundo_apellido:[null]})}ngOnInit(){return f(this,null,function*(){yield this.cargarPerfil()})}cargarPerfil(){return f(this,null,function*(){this.isLoading=!0,this.perfilActual=null;try{let n=yield h.auth.getUser();this.usuarioActual=n.data.user;let t=yield this.authService.miPerfil();if(!t){this.mostrarToast("No se pudo cargar el perfil.","danger");return}this.perfilActual=t,this.perfilForm.patchValue({segundo_nombre:t.segundo_nombre,telefono:t.telefono,segundo_apellido:t.segundo_apellido}),this.perfilForm.markAsPristine()}catch(n){console.error("Error al cargar perfil:",n),this.mostrarToast("Error cr\xEDtico al cargar el perfil.","danger")}finally{this.isLoading=!1}})}eliminarFotoAnterior(n){return f(this,null,function*(){if(!n)return;let t=n.split(M+"/");if(t.length<2)return;let e=t[1],{error:l}=yield h.storage.from(M).remove([e]);l&&console.error("Error al eliminar foto anterior:",l)})}subirYActualizarFoto(){return f(this,null,function*(){if(!this.fotoFile||!this.usuarioActual)return null;this.isUploading=!0;let n=this.usuarioActual;try{let t=this.fotoFile.name.split(".").pop(),e=`users/${n.id}/profile_avatar_${Date.now()}.${t}`,{error:l}=yield h.storage.from(M).upload(e,this.fotoFile,{cacheControl:"3600",upsert:!1});if(l)throw l;let{data:u}=h.storage.from(M).getPublicUrl(e),m=u.publicUrl;return this.perfilActual?.url_foto_perfil&&(yield this.eliminarFotoAnterior(this.perfilActual.url_foto_perfil)),m}catch(t){return console.error("Fallo en la subida:",t),this.mostrarToast("Fallo la subida de la foto.","danger"),null}finally{this.isUploading=!1}})}onFileSelected(n){let t=n.target.files;t.length>0?this.fotoFile=t[0]:this.fotoFile=null}guardarCambios(){return f(this,null,function*(){if(!(this.perfilForm.invalid||!this.perfilForm.dirty&&!this.fotoFile)){this.isSaving=!0;try{let n=null;if(this.fotoFile&&(n=yield this.subirYActualizarFoto(),!n)){this.isSaving=!1;return}let t=this.perfilForm.getRawValue(),e={segundo_nombre:t.segundo_nombre||null,segundo_apellido:t.segundo_apellido||null,telefono:t.telefono||null,url_foto_perfil:n??this.perfilActual?.url_foto_perfil??null};yield this.authService.updateUsuarioExtras(e),this.mostrarToast("Perfil actualizado con \xE9xito.","success"),this.fotoFile=null,yield this.cargarPerfil()}catch(n){console.error("Error al guardar:",n),this.mostrarToast(`Error al guardar: ${n.message}`,"danger")}finally{this.isSaving=!1}}})}logout(){return f(this,null,function*(){yield this.authService.signOut(),this.router.navigateByUrl("/auth/login",{replaceUrl:!0})})}mostrarToast(n,t){return f(this,null,function*(){yield(yield this.toastController.create({message:n,duration:3e3,position:"bottom",color:t})).present()})}};d.\u0275fac=function(t){return new(t||d)(P(j),P(ae),P(oe),P(A))},d.\u0275cmp=y({type:d,selectors:[["app-perfil"]],decls:55,vars:22,consts:[["fileInput",""],[1,"rb-header"],["slot","start"],["defaultHref","/home"],["slot","end"],["color","light",3,"click"],["name","log-out-outline","slot","icon-only"],[3,"fullscreen"],[1,"perfil-page"],[1,"card","ion-no-margin"],[1,"profile-photo-container","ion-text-center","ion-padding-bottom"],["alt","Foto de perfil",1,"profile-avatar",3,"src"],["type","file","accept","image/png, image/jpeg",2,"display","none",3,"change"],["fill","clear","size","small",2,"margin-top","8px",3,"click","disabled"],["name","camera-outline","slot","start"],["name","dots",4,"ngIf"],["class","verification-status is-pending",4,"ngIf"],[3,"ngSubmit","formGroup"],["lines","none",1,"field","is-static",3,"disabled"],["label","Nombre Completo","labelPlacement","stacked","placeholder","Cargando...","readonly","",3,"value"],["label","Primer Nombre","labelPlacement","stacked","placeholder","Cargando...","readonly","",3,"value"],["label","Primer Apellido","labelPlacement","stacked","placeholder","Cargando...","readonly","",3,"value"],["lines","none",1,"field"],["label","Segundo Nombre","labelPlacement","stacked","formControlName","segundo_nombre","placeholder","Segundo nombre (Opcional)"],["label","Segundo Apellido","labelPlacement","stacked","formControlName","segundo_apellido","placeholder","Segundo apellido (Opcional)"],["label","Tel\xE9fono","labelPlacement","stacked","formControlName","telefono","placeholder","Ej: +56912345678","type","tel"],["color","danger",4,"ngIf"],["label","Correo Electr\xF3nico","labelPlacement","stacked","placeholder","Cargando...","readonly","",3,"value"],[1,"actions"],["type","submit","expand","block",3,"disabled"],[4,"ngIf"],["label","Rol de Usuario","labelPlacement","stacked","readonly","",3,"value"],["name","dots"],[1,"verification-status","is-pending"],["color","danger"]],template:function(t,e){if(t&1){let l=x();i(0,"ion-header",1)(1,"ion-toolbar")(2,"ion-buttons",2),p(3,"ion-back-button",3),a(),i(4,"ion-title"),s(5,"Mi Perfil"),a(),i(6,"ion-buttons",4)(7,"ion-button",5),C("click",function(){return _(l),b(e.logout())}),p(8,"ion-icon",6),a()()()(),i(9,"ion-content",7)(10,"div",8)(11,"ion-card",9)(12,"ion-card-header")(13,"ion-card-title"),s(14,"Datos Personales"),a(),i(15,"ion-card-subtitle"),s(16,"Informaci\xF3n b\xE1sica y de contacto."),a()(),i(17,"ion-card-content")(18,"div",10),p(19,"img",11),i(20,"input",12,0),C("change",function(m){return _(l),b(e.onFileSelected(m))}),a(),i(22,"ion-button",13),C("click",function(){_(l);let m=w(21);return b(m.click())}),p(23,"ion-icon",14),s(24),g(25,le,1,0,"ion-spinner",15),a()(),g(26,ce,2,0,"div",16),i(27,"form",17),C("ngSubmit",function(){return _(l),b(e.guardarCambios())}),i(28,"ion-item",18),p(29,"ion-input",19),a(),i(30,"ion-item",18),p(31,"ion-input",20),a(),i(32,"ion-item",18),p(33,"ion-input",21),a(),i(34,"ion-item",22),p(35,"ion-input",23),a(),i(36,"ion-item",22),p(37,"ion-input",24),a(),i(38,"ion-item",22),p(39,"ion-input",25),a(),g(40,de,2,1,"ion-text",26),i(41,"ion-item",18),p(42,"ion-input",27),a(),i(43,"div",28)(44,"ion-button",29),g(45,se,2,0,"span",30)(46,fe,2,0,"span",30)(47,ge,1,0,"ion-spinner",15),a()()()()(),i(48,"ion-card",9)(49,"ion-card-header")(50,"ion-card-title"),s(51,"Informaci\xF3n Adicional"),a()(),i(52,"ion-card-content")(53,"ion-item",18),p(54,"ion-input",31),a()()()()()}if(t&2){let l;o(9),r("fullscreen",!0),o(10),r("src",(e.perfilActual==null?null:e.perfilActual.url_foto_perfil)||"assets/default_avatar.svg",v),o(3),r("disabled",e.isUploading||e.isSaving),o(2),F(" ",e.fotoFile?"Cambiar ("+e.fotoFile.name.substring(0,15)+"...)":"Seleccionar Foto"," "),o(),r("ngIf",e.isUploading),o(),r("ngIf",e.perfilActual&&!e.perfilActual.verificado),o(),r("formGroup",e.perfilForm),o(),r("disabled",!0),o(),r("value",(e.perfilActual==null?null:e.perfilActual.nombre)||"N/A"),o(),r("disabled",!0),o(),r("value",(e.perfilActual==null?null:e.perfilActual.primer_nombre)||"N/A"),o(),r("disabled",!0),o(),r("value",(e.perfilActual==null?null:e.perfilActual.primer_apellido)||"N/A"),o(7),r("ngIf",((l=e.perfilForm.get("telefono"))==null?null:l.errors)&&(((l=e.perfilForm.get("telefono"))==null?null:l.dirty)||((l=e.perfilForm.get("telefono"))==null?null:l.touched))),o(),r("disabled",!0),o(),r("value",(e.perfilActual==null?null:e.perfilActual.correo)||"N/A"),o(2),r("disabled",e.perfilForm.invalid||!e.perfilForm.dirty&&!e.fotoFile||e.isSaving||e.isUploading),o(),r("ngIf",!e.isSaving&&!e.isUploading),o(),r("ngIf",e.isSaving||e.isUploading),o(),r("ngIf",e.isSaving||e.isUploading),o(6),r("disabled",!0),o(),r("value",(e.perfilActual==null?null:e.perfilActual.rol)||"vecino")}},dependencies:[re,z,D,G,H,L,$,Y,K,q,J,Q,W,Z,ee,te,ne,R,ie,E,I,B,N,T,U,V,X],styles:['@charset "UTF-8";[_nghost-%COMP%]{--rb-primary: #2563eb;--rb-primary-10: rgba(37, 99, 235, .1);--rb-primary-20: rgba(37, 99, 235, .2);--rb-bg: #ffffff;--rb-text: #0f172a;--rb-muted: #64748b;color-scheme:light;--ion-background-color: var(--rb-bg);--ion-text-color: var(--rb-text);--ion-item-background: #ffffff;--ion-card-background: #ffffff}.rb-header[_ngcontent-%COMP%]   ion-toolbar[_ngcontent-%COMP%]{--background: linear-gradient(135deg, var(--rb-primary), #60a5fa);--color: #fff;--border-color: transparent;--min-height: 56px}.perfil-page[_ngcontent-%COMP%]{max-width:600px;margin:0 auto;padding:16px;--background: var(--rb-bg)}.perfil-page[_ngcontent-%COMP%]   .card[_ngcontent-%COMP%]{background:#fff;border:1px solid rgba(2,6,23,.06);border-radius:18px;box-shadow:0 10px 26px #02061714;overflow:hidden;margin-bottom:24px}.perfil-page[_ngcontent-%COMP%]   .card[_ngcontent-%COMP%]   ion-card-header[_ngcontent-%COMP%]{background:#fff;border-bottom:1px solid rgba(2,6,23,.06);padding-bottom:12px}.perfil-page[_ngcontent-%COMP%]   .card[_ngcontent-%COMP%]   ion-card-title[_ngcontent-%COMP%]{font-weight:800;color:var(--rb-text)}.perfil-page[_ngcontent-%COMP%]   .card[_ngcontent-%COMP%]   ion-card-subtitle[_ngcontent-%COMP%]{color:var(--rb-muted);font-weight:500;margin-top:6px;display:block}.perfil-page[_ngcontent-%COMP%]   .card[_ngcontent-%COMP%]   ion-card-content[_ngcontent-%COMP%]{padding-bottom:24px}.perfil-page[_ngcontent-%COMP%]   .card[_ngcontent-%COMP%]   .field[_ngcontent-%COMP%]{--background: #fff;background:#fff;border:1.5px solid #e2e8f0;border-radius:14px;box-shadow:0 8px 18px #0206170f;--padding-start: 12px;--inner-padding-end: 12px;--inner-padding-top: 12px;--inner-padding-bottom: 12px;--min-height: auto;margin:14px 0;transition:border-color .16s ease,box-shadow .16s ease}.perfil-page[_ngcontent-%COMP%]   .card[_ngcontent-%COMP%]   .field[_ngcontent-%COMP%]   ion-label[_ngcontent-%COMP%]{margin:2px 4px 6px 2px;line-height:1.2;color:#334155;font-weight:700}.perfil-page[_ngcontent-%COMP%]   .card[_ngcontent-%COMP%]   .field[_ngcontent-%COMP%]   ion-input[_ngcontent-%COMP%]::part(native), .perfil-page[_ngcontent-%COMP%]   .card[_ngcontent-%COMP%]   .field[_ngcontent-%COMP%]   ion-textarea[_ngcontent-%COMP%]::part(native){color:var(--rb-text);background:#fff;line-height:1.25;font-weight:600;padding:8px 10px 10px;caret-color:var(--rb-primary)}.perfil-page[_ngcontent-%COMP%]   .card[_ngcontent-%COMP%]   .field[_ngcontent-%COMP%]   ion-input[_ngcontent-%COMP%]::part(native)::placeholder, .perfil-page[_ngcontent-%COMP%]   .card[_ngcontent-%COMP%]   .field[_ngcontent-%COMP%]   ion-textarea[_ngcontent-%COMP%]::part(native)::placeholder{color:#6b7280;opacity:1}.perfil-page[_ngcontent-%COMP%]   .card[_ngcontent-%COMP%]   .field.item-has-focus[_ngcontent-%COMP%], .perfil-page[_ngcontent-%COMP%]   .card[_ngcontent-%COMP%]   .field[_ngcontent-%COMP%]:focus-within{border-color:var(--rb-primary);box-shadow:0 0 0 3px #2563eb24,0 8px 18px #0206170f}.perfil-page[_ngcontent-%COMP%]   .card[_ngcontent-%COMP%]   .field[disabled][_ngcontent-%COMP%], .perfil-page[_ngcontent-%COMP%]   .card[_ngcontent-%COMP%]   .field.is-static[_ngcontent-%COMP%]{--background: #f1f5f9 !important;background:#f1f5f9!important;opacity:.95;box-shadow:none;border-color:#e2e8f0}.perfil-page[_ngcontent-%COMP%]   .card[_ngcontent-%COMP%]   .field[disabled][_ngcontent-%COMP%]   ion-label[_ngcontent-%COMP%], .perfil-page[_ngcontent-%COMP%]   .card[_ngcontent-%COMP%]   .field.is-static[_ngcontent-%COMP%]   ion-label[_ngcontent-%COMP%]{color:var(--rb-muted)!important;font-weight:600}.perfil-page[_ngcontent-%COMP%]   .card[_ngcontent-%COMP%]   .field[disabled][_ngcontent-%COMP%]   ion-input[_ngcontent-%COMP%]::part(native), .perfil-page[_ngcontent-%COMP%]   .card[_ngcontent-%COMP%]   .field[disabled][_ngcontent-%COMP%]   ion-textarea[_ngcontent-%COMP%]::part(native), .perfil-page[_ngcontent-%COMP%]   .card[_ngcontent-%COMP%]   .field.is-static[_ngcontent-%COMP%]   ion-input[_ngcontent-%COMP%]::part(native), .perfil-page[_ngcontent-%COMP%]   .card[_ngcontent-%COMP%]   .field.is-static[_ngcontent-%COMP%]   ion-textarea[_ngcontent-%COMP%]::part(native){color:#334155!important;font-weight:500;background:transparent!important}.perfil-page[_ngcontent-%COMP%]   .card[_ngcontent-%COMP%]   ion-text[color=danger][_ngcontent-%COMP%]{display:block;margin:4px 6px 0;font-size:.9rem;font-weight:600}.perfil-page[_ngcontent-%COMP%]   .card[_ngcontent-%COMP%]   .actions[_ngcontent-%COMP%]{margin-top:24px;padding:0 0 16px}.perfil-page[_ngcontent-%COMP%]   .card[_ngcontent-%COMP%]   .actions[_ngcontent-%COMP%]   ion-button[_ngcontent-%COMP%]{--border-radius: 14px;--box-shadow: 0 10px 18px var(--rb-primary-10);font-weight:700}.perfil-page[_ngcontent-%COMP%]   .card[_ngcontent-%COMP%]   .actions[_ngcontent-%COMP%]   ion-button[_ngcontent-%COMP%]:active{transform:translateY(1px)}.perfil-page[_ngcontent-%COMP%]   .verification-status[_ngcontent-%COMP%]{margin:10px 0 20px;padding:10px 16px;border-radius:12px;font-weight:600}.perfil-page[_ngcontent-%COMP%]   .verification-status.is-verified[_ngcontent-%COMP%]{background:#dcfce7;color:#16a34a;border:1px solid #bbf7d0}.perfil-page[_ngcontent-%COMP%]   .verification-status.is-pending[_ngcontent-%COMP%]{background:#fef9c3;color:#eab308;border:1px solid #fde68a}@media (max-width: 480px){.perfil-page[_ngcontent-%COMP%]   .card[_ngcontent-%COMP%]   .field[_ngcontent-%COMP%]{box-shadow:0 6px 12px #0206170d}.perfil-page[_ngcontent-%COMP%]{padding:8px}}']});let c=d;return c})();export{xe as PerfilPage};
