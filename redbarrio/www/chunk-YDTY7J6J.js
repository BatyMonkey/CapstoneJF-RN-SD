import{a as S}from"./chunk-TX5AFJTF.js";import{a as v}from"./chunk-66QFWZLQ.js";import{A as d,B as G,C as E,D as R,Ea as oe,Fa as ne,I as V,Na as ae,O as z,P as D,Ra as le,S as L,Sa as se,Ua as ce,Va as ue,Wa as de,Xa as pe,Ya as me,_ as B,_a as fe,ba as q,c as T,ca as C,da as $,ea as X,f as I,g as P,ha as j,i as a,ib as ge,j as A,ja as K,jb as be,k as U,ka as H,kb as he,la as J,lb as _e,m as f,ma as W,mb as ve,na as Y,o as u,oa as Q,p as l,pa as Z,q as s,r as g,ra as ee,sa as te,u as O,ua as re,v as _,vb as xe,w as b,wb as F,x as k,za as ie}from"./chunk-H7HGEQUX.js";import"./chunk-G4GOZ2R2.js";import"./chunk-2GHFZAQB.js";import"./chunk-QUJFQN2Y.js";import"./chunk-VBARJE22.js";import"./chunk-6T3MRKSY.js";import"./chunk-LG5HFCS7.js";import"./chunk-PTM2QU7L.js";import"./chunk-Z7QLWI7J.js";import"./chunk-DNXVUVY2.js";import"./chunk-JS56SECH.js";import"./chunk-GFYYGWWH.js";import"./chunk-EXVGCGBZ.js";import"./chunk-IACAUHTZ.js";import"./chunk-WIVIOYVM.js";import"./chunk-ULQSOQCK.js";import"./chunk-JOPIHTUJ.js";import"./chunk-MTHZ7MWU.js";import"./chunk-WI5MSH4N.js";import"./chunk-EKNMT7ZB.js";import"./chunk-CKP3SGE2.js";import"./chunk-K6CL52MX.js";import{j as m}from"./chunk-VI73JOY6.js";var ye=(()=>{let o=class o{constructor(){this.perfilCache=null,this.TABLE_VIEW="noticias_con_autor",this.TABLE_NAME="noticias",this.BUCKET_NAME="noticias-bucket",this.supabase=F(v.supabaseUrl,v.supabaseAnonKey)}getCurrentUserId(){return m(this,null,function*(){try{let{data:{user:e},error:r}=yield this.supabase.auth.getUser();if(r)throw r;return e?.id||null}catch(e){return console.error("Error al obtener el usuario de Supabase:",e),null}})}getUsuarioForzado(){try{let e=this.perfilCache;if(e)return e;let r=localStorage.getItem("rb_usuario_activo");return r?JSON.parse(r):null}catch{return null}}setUsuarioForzado(e){this.perfilCache=e,localStorage.setItem("rb_usuario_activo",JSON.stringify(e))}getNoticias(){return m(this,null,function*(){let{data:e,error:r}=yield this.supabase.from(this.TABLE_VIEW).select("*").order("fecha_creacion",{ascending:!1});return r?(console.warn("Error al obtener noticias:",r),null):e})}getNoticiaById(e){return m(this,null,function*(){let{data:r,error:t}=yield this.supabase.from(this.TABLE_VIEW).select("*").eq("id",e).single();return t?(console.error("Error al obtener el detalle de la noticia:",t),null):r})}subirFotoNoticia(e){return m(this,null,function*(){let r=e.name.split(".").pop(),t=`${crypto.randomUUID()}.${r}`,{data:n,error:p}=yield this.supabase.storage.from(this.BUCKET_NAME).upload(t,e,{cacheControl:"3600",upsert:!1});if(p)return console.error("Error al subir foto a Storage:",p),null;let{data:x}=this.supabase.storage.from(this.BUCKET_NAME).getPublicUrl(n.path);return x.publicUrl})}crearNoticia(e){return m(this,null,function*(){let{data:r,error:t}=yield this.supabase.from(this.TABLE_NAME).insert([e]).select().single();return t?(console.error("Error al crear noticia:",t),null):r})}};o.\u0275fac=function(r){return new(r||o)},o.\u0275prov=T({token:o,factory:o.\u0275fac,providedIn:"root"});let i=o;return i})();function Ae(i,o){i&1&&(l(0,"p"),d(1,"El t\xEDtulo es obligatorio."),s())}function Ee(i,o){if(i&1&&(l(0,"div")(1,"ion-text",16),f(2,Ae,2,0,"p",9),s()()),i&2){let c,e=b();a(2),u("ngIf",(c=e.noticiaForm.get("titulo"))==null||c.errors==null?null:c.errors.required)}}function Fe(i,o){i&1&&(l(0,"p"),d(1,"El primer p\xE1rrafo es obligatorio."),s())}function Me(i,o){if(i&1&&(l(0,"div")(1,"ion-text",16),f(2,Fe,2,0,"p",9),s()()),i&2){let c=b().$implicit;a(2),u("ngIf",c.errors==null?null:c.errors.required)}}function Ne(i,o){if(i&1){let c=O();l(0,"div")(1,"ion-item",19),g(2,"ion-textarea",20),l(3,"ion-buttons",21)(4,"ion-button",22),_("click",function(){let r=I(c).index,t=b();return P(t.quitarParrafo(r))}),g(5,"ion-icon",23),s()()(),f(6,Me,3,1,"div",9),s()}if(i&2){let c=o.$implicit,e=o.index,r=b();a(),u("formGroupName",e),a(),u("label",V("P\xE1rrafo ",e+1))("formControl",c)("autoGrow",!0),a(2),u("disabled",r.parrafosFormArray.length<=1),a(2),u("ngIf",c.invalid&&(c.dirty||c.touched))}}function Oe(i,o){if(i&1){let c=O();l(0,"ion-item",24)(1,"ion-label",25),d(2),s(),l(3,"div",26)(4,"p",27),d(5),s(),l(6,"input",28,0),_("change",function(r){let t=I(c).index,n=b();return P(n.onFileSelected(r,t))}),s(),l(8,"ion-button",29),_("click",function(){I(c);let r=k(7);return P(r.click())}),d(9," Seleccionar archivo "),s()()()}if(i&2){let c=o.index,e=b();a(2),E(" ",c===0?"Imagen de Portada (Obligatoria)":"Imagen "+c+" (Opcional)"," "),a(3),E(" ",(e.archivosSeleccionados[c]==null?null:e.archivosSeleccionados[c].name)||"Sin archivos seleccionados"," "),a(),u("required",c===0)}}function we(i,o){i&1&&(l(0,"p"),d(1," Debe seleccionar una Imagen de Portada. "),s())}function Te(i,o){i&1&&(l(0,"span"),d(1,"Guardar Noticia"),s())}function Ue(i,o){i&1&&(l(0,"span"),d(1,"Subiendo Im\xE1genes..."),s())}function ke(i,o){i&1&&(l(0,"span"),d(1,"Guardando..."),s())}function Ge(i,o){i&1&&g(0,"ion-spinner",30)}var Ce="noticias-bucket",Se=6,M=5,Ye=(()=>{let o=class o{constructor(e,r,t){this.fb=e,this.router=r,this.noticiasService=t,this.estaGuardando=!1,this.usuarioAutenticado=null,this.nombreAutor=null,this.archivosSeleccionados=new Array(M).fill(null),this.estaSubiendoImagen=!1,this.MAX_PARRAFOS=Se,this.MAX_IMAGENES=M,this.supabase=F(v.supabaseUrl,v.supabaseAnonKey)}get parrafosFormArray(){return this.noticiaForm.get("parrafos")}get parrafoControls(){return this.parrafosFormArray.controls}ngOnInit(){return m(this,null,function*(){this.noticiaForm=this.fb.group({titulo:["",[C.required,C.maxLength(100)]],parrafos:this.fb.array([])}),this.agregarParrafo(!0),this.noticiaForm.reset(),yield this.inicializarUsuarioYAutor()})}crearParrafoControl(e=!1){let r=e?[C.required]:[];return new j(null,r)}agregarParrafo(e=!1){this.parrafosFormArray.length<Se&&this.parrafosFormArray.push(this.crearParrafoControl(e))}quitarParrafo(e){this.parrafosFormArray.length>1&&(this.parrafosFormArray.removeAt(e),e===0&&this.parrafosFormArray.length>0&&(this.parrafosFormArray.at(0).setValidators([C.required]),this.parrafosFormArray.at(0).updateValueAndValidity()))}inicializarUsuarioYAutor(){return m(this,null,function*(){let{data:{user:e}}=yield this.supabase.auth.getUser();if(this.usuarioAutenticado=e,!e){try{let r=this.noticiasService.getUsuarioForzado?.()??null;if(r){this.usuarioAutenticado={id:r.id_auth||r.user_id},this.nombreAutor=r.nombre||"Autor Desconocido";return}}catch{}this.router.navigate(["/login"]);return}try{let{data:r,error:t}=yield this.supabase.from("usuario").select("nombre").eq("user_id",e.id).single();if(t&&t.code!=="PGRST116")throw t;this.nombreAutor=r?.nombre||"Autor Desconocido"}catch{this.nombreAutor="Autor Desconocido"}})}onFileSelected(e,r){let t=e.target.files[0];t?this.archivosSeleccionados[r]=t:this.archivosSeleccionados[r]=null}subirImagenes(){return m(this,null,function*(){let e=yield S.auth.getSession(),r=e.data.session,t=this.usuarioAutenticado;try{let p=this.noticiasService?.getUsuarioForzado?.()??null;console.debug("[crear-noticia] Supabase getSession result:",e),console.debug("[crear-noticia] usuarioAutenticado:",t),console.debug("[crear-noticia] perfil forzado (local):",p)}catch(p){console.debug("[crear-noticia] error al leer perfil forzado:",p)}if(!r)return console.warn("Intento de subir im\xE1genes sin sesi\xF3n Supabase activa. Perfil forzado presente:",this.noticiasService?.getUsuarioForzado?.()),alert("No hay una sesi\xF3n activa en Supabase. Para subir im\xE1genes debes iniciar sesi\xF3n. Si est\xE1s en modo desarrollo y usas un perfil forzado, inicia sesi\xF3n real para habilitar Storage."),null;if(!t)return console.warn("Usuario nulo en subirImagenes despite active session"),alert("No se pudo determinar el usuario para la subida de im\xE1genes. Inicia sesi\xF3n y vuelve a intentarlo."),null;this.estaSubiendoImagen=!0;let n=[];if(!this.archivosSeleccionados[0])return alert("La primera imagen es obligatoria."),this.estaSubiendoImagen=!1,null;try{for(let p=0;p<M;p++){let x=this.archivosSeleccionados[p];if(x){let h=`${t.id}/noticias/${Date.now()}_${p}_${x.name.replace(/ /g,"_")}`,y=yield S.storage.from(Ce).upload(h,x);if(console.debug("[crear-noticia] upload response for",h,y),y.error)return console.error("Supabase upload error for",h,y.error),alert("Error subiendo im\xE1genes: "+(y.error.message||JSON.stringify(y.error))),this.estaSubiendoImagen=!1,null;let N=yield S.storage.from(Ce).getPublicUrl(h);console.debug("[crear-noticia] getPublicUrl response for",h,N);let w=N?.data?.publicUrl;if(!w)return console.error("No public URL returned for",h,N),alert("No se pudo obtener la URL p\xFAblica de la imagen."),this.estaSubiendoImagen=!1,null;n.push(w)}}return this.estaSubiendoImagen=!1,n}catch(p){return this.estaSubiendoImagen=!1,console.error("Error subiendo im\xE1genes:",p),alert("Error subiendo las im\xE1genes. Intenta de nuevo."),null}})}crearNoticia(){return m(this,null,function*(){if(this.noticiaForm.markAllAsTouched(),this.parrafosFormArray.invalid||this.noticiaForm.invalid||this.estaGuardando||this.estaSubiendoImagen||!this.usuarioAutenticado){alert("Por favor, completa el t\xEDtulo y el primer p\xE1rrafo antes de continuar.");return}this.estaGuardando=!0;let e=yield this.subirImagenes();if(e===null){this.estaGuardando=!1;return}let r=this.parrafosFormArray.controls.map(n=>n.value).filter(n=>n&&n.trim().length>0),t={titulo:this.noticiaForm.value.titulo,parrafos:r,url_foto:e,nombre_autor:this.nombreAutor,fecha_creacion:new Date().toISOString(),user_id:this.usuarioAutenticado.id};try{let{error:n}=yield S.from("noticias").insert(t);n?(console.error("Error al guardar noticia en Supabase:",n),alert("Hubo un error al crear la noticia. Detalle: "+n.message)):(alert("Noticia creada con \xE9xito!"),this.noticiaForm.reset(),this.parrafosFormArray.clear(),this.agregarParrafo(!0),this.archivosSeleccionados=new Array(M).fill(null),this.router.navigateByUrl("/home",{replaceUrl:!0}))}catch(n){console.error("Error inesperado:",n),alert("Ocurri\xF3 un error inesperado.")}finally{this.estaGuardando=!1}})}};o.\u0275fac=function(r){return new(r||o)(A(te),A(B),A(ye))},o.\u0275cmp=U({type:o,selectors:[["app-crear-noticia"]],decls:37,vars:17,consts:[["fileInput",""],[1,"rb-header"],["slot","start"],["menu","mainMenu","autoHide","false"],[1,"ion-padding",3,"fullscreen"],["color","medium"],[3,"ngSubmit","formGroup"],["lines","full",1,"ion-margin-bottom"],["label","T\xEDtulo","labelPlacement","stacked","formControlName","titulo","placeholder","M\xE1x 100 caracteres","required","",3,"maxlength"],[4,"ngIf"],["formArrayName","parrafos",1,"ion-margin-vertical"],[4,"ngFor","ngForOf"],["expand","block","fill","outline",1,"ion-margin-bottom",3,"click","disabled"],["name","add-circle-outline","slot","start"],[1,"ion-margin-vertical"],["lines","full",4,"ngFor","ngForOf"],["color","danger",1,"ion-padding-start"],["type","submit","expand","block",1,"ion-margin-top",3,"disabled"],["slot","end","name","dots",4,"ngIf"],["lines","full",1,"ion-margin-bottom",3,"formGroupName"],["labelPlacement","stacked","placeholder","Escribe el contenido aqu\xED...","rows","4",3,"label","formControl","autoGrow"],["slot","end"],["color","danger",3,"click","disabled"],["name","trash-outline"],["lines","full"],["slot","start",1,"ion-text-wrap"],["slot","end",1,"ion-text-end"],[1,"ion-no-margin","ion-text-wrap",2,"font-size","0.9em","color","var(--ion-color-medium)"],["type","file","accept","image/jpeg, image/png",2,"display","none",3,"change","required"],["size","small",3,"click"],["slot","end","name","dots"]],template:function(r,t){if(r&1&&(l(0,"ion-header",1)(1,"ion-toolbar")(2,"ion-buttons",2),g(3,"ion-menu-button",3),s(),l(4,"ion-title"),d(5,"Crear Nueva Noticia"),s()()(),l(6,"ion-content",4)(7,"ion-text",5)(8,"p"),d(9,"Creando como: "),l(10,"strong"),d(11),s()()(),l(12,"form",6),_("ngSubmit",function(){return t.crearNoticia()}),l(13,"ion-item",7),g(14,"ion-input",8),s(),f(15,Ee,3,1,"div",9),l(16,"ion-list",10)(17,"ion-list-header")(18,"ion-label"),d(19),s()(),f(20,Ne,7,7,"div",11),s(),l(21,"ion-button",12),_("click",function(){return t.agregarParrafo()}),g(22,"ion-icon",13),d(23),s(),g(24,"hr"),l(25,"ion-list",14)(26,"ion-list-header")(27,"ion-label"),d(28,"Im\xE1genes (La primera es la Portada)"),s()(),f(29,Oe,10,3,"ion-item",15),l(30,"ion-text",16),f(31,we,2,0,"p",9),s()(),l(32,"ion-button",17),f(33,Te,2,0,"span",9)(34,Ue,2,0,"span",9)(35,ke,2,0,"span",9)(36,Ge,1,0,"ion-spinner",18),s()()()),r&2){let n;a(6),u("fullscreen",!0),a(5),G(t.nombreAutor||"Cargando..."),a(),u("formGroup",t.noticiaForm),a(2),u("maxlength",100),a(),u("ngIf",((n=t.noticiaForm.get("titulo"))==null?null:n.invalid)&&(((n=t.noticiaForm.get("titulo"))==null?null:n.dirty)||((n=t.noticiaForm.get("titulo"))==null?null:n.touched))),a(4),E("Contenido (P\xE1rrafos - M\xE1x ",t.MAX_PARRAFOS,")"),a(),u("ngForOf",t.parrafoControls),a(),u("disabled",t.parrafosFormArray.length>=t.MAX_PARRAFOS),a(2),R(" A\xF1adir P\xE1rrafo (",t.parrafosFormArray.length,"/",t.MAX_PARRAFOS,") "),a(6),u("ngForOf",t.archivosSeleccionados),a(2),u("ngIf",!t.archivosSeleccionados[0]&&t.noticiaForm.touched),a(),u("disabled",t.estaGuardando||t.estaSubiendoImagen||t.noticiaForm.invalid),a(),u("ngIf",!t.estaGuardando&&!t.estaSubiendoImagen),a(),u("ngIf",t.estaSubiendoImagen),a(),u("ngIf",t.estaGuardando&&!t.estaSubiendoImagen),a(),u("ngIf",t.estaGuardando||t.estaSubiendoImagen)}},dependencies:[L,z,D,xe,oe,ne,ae,le,se,ce,ue,de,pe,me,fe,ge,be,he,_e,ve,ie,q,re,K,$,X,Z,ee,H,J,Q,W,Y],styles:['@charset "UTF-8";[_nghost-%COMP%]{--rb-primary: #2563eb;--rb-primary-10: rgba(37, 99, 235, .1);--rb-primary-20: rgba(37, 99, 235, .2);--rb-text: #0f172a;--rb-muted: #64748b;color-scheme:light;--ion-text-color: var(--rb-text);--ion-background-color: #f7fbff}ion-content[_ngcontent-%COMP%]{--background: linear-gradient(180deg, #f7fbff 0%, #e8f0ff 100%);color:var(--rb-text)}ion-toolbar[_ngcontent-%COMP%]{--background: linear-gradient(135deg, var(--rb-primary), #60a5fa);--color: #fff;--border-color: transparent;--min-height: 56px}form[_ngcontent-%COMP%]{max-width:860px;margin:16px auto}ion-text[color=medium][_ngcontent-%COMP%]{display:block;max-width:860px;margin:8px auto 0;color:var(--rb-muted)}ion-item[_ngcontent-%COMP%]{--background: #fff;background:#fff;border:1.5px solid #e2e8f0;border-radius:14px;box-shadow:0 8px 18px #0206170f;--padding-start: 12px;--inner-padding-end: 12px;--inner-padding-top: 12px;--inner-padding-bottom: 12px;--min-height: auto;margin-top:12px;transition:border-color .16s ease,box-shadow .16s ease;color:var(--rb-text)}ion-item.item-has-focus[_ngcontent-%COMP%], ion-item[_ngcontent-%COMP%]:focus-within{border-color:var(--rb-primary);box-shadow:0 0 0 3px #2563eb24,0 8px 18px #0206170f}ion-input[_ngcontent-%COMP%]::part(label), ion-textarea[_ngcontent-%COMP%]::part(label), ion-input[label-placement=stacked][_ngcontent-%COMP%]::part(label), ion-textarea[label-placement=stacked][_ngcontent-%COMP%]::part(label){color:#1f2937!important;opacity:1!important;transform:none!important;margin:2px 4px 6px 2px;line-height:1.2;font-weight:700;z-index:1}ion-input[_ngcontent-%COMP%], ion-textarea[_ngcontent-%COMP%]{--color: var(--rb-text) !important;--placeholder-color: #475569 !important}ion-input[_ngcontent-%COMP%]::part(native), ion-textarea[_ngcontent-%COMP%]::part(native){color:var(--rb-text)!important;-webkit-text-fill-color:var(--rb-text)!important;background:#fff;line-height:1.25;font-weight:600;padding:8px 10px 10px;caret-color:var(--rb-primary)}ion-input[_ngcontent-%COMP%]::part(native)::placeholder, ion-textarea[_ngcontent-%COMP%]::part(native)::placeholder{color:#475569!important;opacity:1}ion-textarea[_ngcontent-%COMP%]{min-height:110px}ion-text[color=danger][_ngcontent-%COMP%]   p[_ngcontent-%COMP%]{font-size:.9rem;margin:6px 0 0}ion-list[_ngcontent-%COMP%]{background:transparent}ion-list-header[_ngcontent-%COMP%]{padding-inline-start:0;margin-top:12px;margin-bottom:6px}ion-list-header[_ngcontent-%COMP%]   ion-label[_ngcontent-%COMP%]{font-weight:700;color:var(--rb-text)}ion-button[_ngcontent-%COMP%]{--border-radius: 12px;--box-shadow: 0 8px 18px var(--rb-primary-10)}ion-button[fill=outline][_ngcontent-%COMP%]{--border-color: var(--rb-primary-20);--color: var(--rb-primary);--ripple-color: var(--rb-primary)}ion-item[_ngcontent-%COMP%]   ion-buttons[slot=end][_ngcontent-%COMP%]{margin-left:8px}hr[_ngcontent-%COMP%]{border:none;height:1px;background:linear-gradient(to right,transparent,rgba(2,6,23,.08),transparent);margin:16px 0}ion-item[_ngcontent-%COMP%]   .ion-text-end[_ngcontent-%COMP%]   p[_ngcontent-%COMP%]{font-size:.9em;color:#334155!important;font-weight:600}ion-button[type=submit][_ngcontent-%COMP%]{margin-top:12px;font-weight:700}ion-button[disabled][_ngcontent-%COMP%]{opacity:.7;filter:grayscale(6%)}@media (max-width: 480px){ion-item[_ngcontent-%COMP%]{box-shadow:0 6px 12px #0206170d}}']});let i=o;return i})();export{Ye as CrearNoticiaPage};
