import{a as r}from"./chunk-3ODY6JMO.js";import{b as _}from"./chunk-C6RY7PX2.js";import{d as g,j as i}from"./chunk-VI73JOY6.js";var f="rb_pending_full",E=(()=>{let l=class l{signUpFull(e){return i(this,null,function*(){let p=e,{email:o,password:n,nombre:s}=p,t=g(p,["email","password","nombre"]),{data:a,error:u}=yield r.auth.signUp({email:o,password:n,options:{data:{full_name:(s??"").trim()}}});if(u)throw u;let{data:m}=yield r.auth.getSession();if(!m.session)return localStorage.setItem(f,JSON.stringify({nombre:s,extras:t})),{needsEmailConfirm:!0};let d=m.session?.user.id??a.user?.id??null;if(!d)throw new Error("No se obtuvo el ID de auth del usuario.");let w=new Date().toISOString(),y={id_auth:d,user_id:d,nombre:(s??"").trim(),correo:o.toLowerCase().trim(),rol:"vecino",verificado:!1,creado_en:w,actualizado_en:w,primer_nombre:t.primer_nombre??null,segundo_nombre:t.segundo_nombre??null,primer_apellido:t.primer_apellido??null,segundo_apellido:t.segundo_apellido??null,rut:t.rut??null,direccion:t.direccion??null,telefono:t.telefono??null,fecha_nacimiento:t.fecha_nacimiento??null,sexo:t.sexo??null},{error:h}=yield r.from("usuario").upsert(y,{onConflict:"id_auth"});if(h)throw h;return{needsEmailConfirm:!1}})}ensureUsuarioRow(e){return i(this,null,function*(){let{data:o}=yield r.auth.getSession(),n=o.session?.user?.id,s=o.session?.user?.email;if(!n||!s)return;let t=new Date().toISOString(),a={id_auth:n,user_id:n,rol:"vecino",verificado:!1,actualizado_en:t,creado_en:t};e&&e.trim()&&(a.nombre=e.trim()),s&&(a.correo=s.toLowerCase().trim());let{error:u}=yield r.from("usuario").upsert(a,{onConflict:"id_auth"});u&&console.warn("ensureUsuarioRow upsert warning:",u)})}signIn(e,o){return i(this,null,function*(){let{data:n,error:s}=yield r.auth.signInWithPassword({email:e,password:o});if(s)throw s;let t=localStorage.getItem(f);if(t)try{let a=JSON.parse(t);yield this.ensureUsuarioRow(a?.nombre??null),a?.extras&&(yield this.updateUsuarioExtras(a.extras))}finally{localStorage.removeItem(f)}else try{yield this.ensureUsuarioRow()}catch{}return n})}signOut(){return i(this,null,function*(){let{error:e}=yield r.auth.signOut();if(e)throw e})}session(){return i(this,null,function*(){let{data:e}=yield r.auth.getSession();return e.session??null})}onAuthChange(e){r.auth.onAuthStateChange(o=>e(o))}miPerfil(){return i(this,null,function*(){let e=yield this.session();if(!e?.user)return null;let{data:o,error:n}=yield r.from("usuario").select("*").eq("id_auth",e.user.id).single();return n?null:o})}miUID(){return i(this,null,function*(){return(yield this.session())?.user?.id??null})}updateUsuarioExtras(e){return i(this,null,function*(){let{data:o}=yield r.auth.getSession(),n=o.session?.user?.id;if(!n)throw new Error("No hay sesi\xF3n");let s={actualizado_en:new Date().toISOString()};for(let[a,u]of Object.entries(e))typeof u<"u"&&(s[a]=u);let{error:t}=yield r.from("usuario").update(s).eq("id_auth",n);if(t)throw t})}};l.\u0275fac=function(o){return new(o||l)},l.\u0275prov=_({token:l,factory:l.\u0275fac,providedIn:"root"});let c=l;return c})();export{E as a};
