import{a}from"./chunk-BSJEIMOO.js";import{c as I}from"./chunk-JZTRD5FY.js";import{a as m,b as _,d as b,j as c}from"./chunk-VI73JOY6.js";var h="rb_pending_full",u="rb_last_uid",N=(()=>{let l=class l{constructor(){this.currentSession=null,this.perfilCache=null,a.auth.onAuthStateChange((e,t)=>{this.currentSession=t,t?.user?.id?localStorage.setItem(u,t.user.id):localStorage.removeItem(u)})}waitForActiveSession(e=2500){return c(this,null,function*(){let t=0,r=250,o=(yield a.auth.getSession()).data.session;for(;!o&&t<e;)yield new Promise(s=>setTimeout(s,r)),t+=r,o=(yield a.auth.getSession()).data.session;if(!o&&localStorage.getItem(u)){let s=localStorage.getItem(u);if(s){let{data:i}=yield a.from("usuario").select("*").eq("id_auth",s).maybeSingle();if(i)return this.perfilCache=i,{access_token:"",token_type:"bearer",user:{id:s}}}}return this.currentSession=o??null,this.currentSession})}construirNombreCompleto(e,t){let r=e.primer_nombre||"",o=t.segundo_nombre??e.segundo_nombre??"",s=e.primer_apellido||"",i=t.segundo_apellido??e.segundo_apellido??"";return[r,o,s,i].filter(n=>n?.trim()).join(" ")}construirNombreRegistro(e){let t=e.primer_nombre||"",r=e.segundo_nombre||"",o=e.primer_apellido||"",s=e.segundo_apellido||"";return[t,r,o,s].filter(i=>i?.trim()).join(" ")}signUpFull(e){return c(this,null,function*(){let S=e,{email:t,password:r}=S,o=b(S,["email","password"]),s=e.nombre?.trim()||this.construirNombreRegistro(e),{data:i,error:n}=yield a.auth.signUp({email:t,password:r,options:{data:{full_name:s}}});if(n)throw n;let{data:w}=yield a.auth.getSession(),f=w.session?.user.id??i.user?.id??null;if(!w.session)return localStorage.setItem(h,JSON.stringify({nombre:s,extras:o})),{needsEmailConfirm:!0};if(!f)throw new Error("No se obtuvo el ID de auth del usuario.");let p=new Date().toISOString(),y=m({id_auth:f,user_id:f,nombre:s,correo:t.toLowerCase().trim(),rol:"vecino",verificado:!1,creado_en:p,actualizado_en:p},o),{error:g}=yield a.from("usuario").upsert(y,{onConflict:"id_auth"});if(g)throw g;return{needsEmailConfirm:!1}})}signIn(e,t){return c(this,null,function*(){let{data:r,error:o}=yield a.auth.signInWithPassword({email:e,password:t});if(o)throw o;r.user?.id&&localStorage.setItem(u,r.user.id);let s=localStorage.getItem(h);if(s)try{let n=JSON.parse(s);yield this.ensureUsuarioRow(n?.nombre??null),n?.extras&&(yield this.updateUsuarioExtras(n.extras))}finally{localStorage.removeItem(h)}else yield this.ensureUsuarioRow();let i=yield this.miPerfil();return i&&this.setUsuarioForzado(i),r})}signOut(){return c(this,null,function*(){yield a.auth.signOut(),this.currentSession=null,this.perfilCache=null,localStorage.removeItem(u),localStorage.removeItem("rb_usuario_activo")})}session(){return c(this,null,function*(){let{data:e}=yield a.auth.getSession();return e.session??null})}miUID(){return c(this,null,function*(){return(yield this.waitForActiveSession())?.user?.id??localStorage.getItem(u)})}miPerfil(){return c(this,null,function*(){if(this.perfilCache)return this.perfilCache;let t=(yield this.waitForActiveSession())?.user?.id??localStorage.getItem(u);if(!t)return null;let{data:r,error:o}=yield a.from("usuario").select("*").eq("id_auth",t).maybeSingle();return o?(console.warn("Error al obtener perfil:",o.message),null):(this.perfilCache=r,this.perfilCache)})}ensureUsuarioRow(e){return c(this,null,function*(){let t=yield this.waitForActiveSession(),r=t?.user?.id,o=t?.user?.email;if(!r||!o)return;let s=new Date().toISOString(),i={id_auth:r,user_id:r,rol:"vecino",verificado:!1,actualizado_en:s,creado_en:s};e?.trim()&&(i.nombre=e.trim()),o&&(i.correo=o.toLowerCase().trim());let{error:n}=yield a.from("usuario").upsert(i,{onConflict:"id_auth"});n&&console.warn("ensureUsuarioRow warning:",n.message)})}updateUsuarioExtras(e){return c(this,null,function*(){let r=(yield this.waitForActiveSession())?.user?.id??localStorage.getItem(u);if(!r)throw new Error("No hay sesi\xF3n");let o=yield this.miPerfil();if(!o)throw new Error("No se pudo obtener el perfil para actualizar.");let s=this.construirNombreCompleto(o,e),i=_(m({},e),{nombre:s,actualizado_en:new Date().toISOString()}),{error:n}=yield a.from("usuario").update(i).eq("id_auth",r);if(n)throw n;this.perfilCache=m(m({},o),i)})}checkIfAdmin(){return c(this,null,function*(){try{let e=yield this.miPerfil();return e?.rol==="administrador"||e?.rol==="directorio"}catch{return!1}})}sendPasswordResetLink(e){return c(this,null,function*(){let t="myapp://auth/reset",{error:r}=yield a.auth.resetPasswordForEmail(e,{redirectTo:t});if(r)throw r.message?.includes("not found")?new Error("No se encontr\xF3 una cuenta con ese correo."):r})}updateUser(e){return c(this,null,function*(){let{error:t}=yield a.auth.updateUser(e);if(t)throw new Error(t.message)})}getUsuarioForzado(){try{let e=this.perfilCache;if(e)return e;let t=localStorage.getItem("rb_usuario_activo");return t?JSON.parse(t):null}catch{return null}}setUsuarioForzado(e){this.perfilCache=e,localStorage.setItem("rb_usuario_activo",JSON.stringify(e))}};l.\u0275fac=function(t){return new(t||l)},l.\u0275prov=I({token:l,factory:l.\u0275fac,providedIn:"root"});let d=l;return d})();export{N as a};
