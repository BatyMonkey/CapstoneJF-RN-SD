import{a as me}from"./chunk-DCNUAMF7.js";import{a as de}from"./chunk-DSYC522I.js";import{a as _}from"./chunk-BSJEIMOO.js";import{a as ce}from"./chunk-CGH6KSUE.js";import{$a as ee,C as y,Da as $,Ea as G,Fa as V,Ga as H,Ha as U,Ia as L,Ja as J,Ma as K,N as F,Na as z,O as N,Qa as Q,R as x,Ta as W,Ua as X,Va as Y,Z as T,Za as Z,ba as f,ca as O,da as k,fb as te,gb as ie,i as c,ia as j,j as d,jb as oe,k as D,ka as A,kb as ne,lb as re,m as g,n as m,na as M,o as i,p as e,q as p,qb as ae,ra as P,ta as R,tb as se,u as w,ub as le,xa as q,ya as B,z as o}from"./chunk-JZTRD5FY.js";import"./chunk-G4GOZ2R2.js";import"./chunk-2GHFZAQB.js";import"./chunk-QUJFQN2Y.js";import"./chunk-VBARJE22.js";import"./chunk-6T3MRKSY.js";import"./chunk-LG5HFCS7.js";import"./chunk-PTM2QU7L.js";import"./chunk-Z7QLWI7J.js";import"./chunk-DNXVUVY2.js";import"./chunk-JS56SECH.js";import"./chunk-GFYYGWWH.js";import"./chunk-EXVGCGBZ.js";import"./chunk-IACAUHTZ.js";import"./chunk-WIVIOYVM.js";import"./chunk-ULQSOQCK.js";import"./chunk-JOPIHTUJ.js";import"./chunk-MTHZ7MWU.js";import"./chunk-WI5MSH4N.js";import"./chunk-EKNMT7ZB.js";import"./chunk-CKP3SGE2.js";import"./chunk-K6CL52MX.js";import{j as u}from"./chunk-VI73JOY6.js";function ue(s,a){if(s&1&&(i(0,"ion-select-option",18),o(1),e()),s&2){let S=a.$implicit;m("value",S.id_espacio),c(),y(" ",S.nombre," - ",S.tipo," ")}}function fe(s,a){s&1&&(i(0,"ion-note",19),o(1," No hay espacios disponibles por ahora. "),e())}var Ne=(()=>{let a=class a{constructor(t,r,n,l,h,v){this.fb=t,this.espaciosService=r,this.authService=n,this.alertCtrl=l,this.toastCtrl=h,this.router=v,this.espaciosDisponibles=[],this.solicitudForm=this.fb.group({id_espacio:["",f.required],descripcion:[""],evento_titulo:["",f.required],evento_descripcion:["",f.required],evento_inicio:["",f.required],evento_fin:["",f.required]})}ngOnInit(){return u(this,null,function*(){yield this.cargarEspaciosDisponibles()})}cargarEspaciosDisponibles(){return u(this,null,function*(){try{let t=yield this.espaciosService.obtenerEspacios();this.espaciosDisponibles=t||[]}catch(t){console.error("Error cargando espacios:",t),this.espaciosDisponibles=[]}})}enviarSolicitud(){return u(this,null,function*(){if(this.solicitudForm.invalid)return;let t=this.solicitudForm.value,n=(yield this.authService.session())?.user?.id||null;if(!n){this.mostrarAlerta("Error","No se pudo obtener el usuario autenticado.");return}try{let{data:l,error:h}=yield _.from("evento").insert([{titulo:t.evento_titulo,descripcion:t.evento_descripcion,fecha_inicio:t.evento_inicio,fecha_fin:t.evento_fin}]).select().single();if(h)throw h;let v=Number(t.id_espacio),{data:pe,error:E}=yield _.from("reserva").insert([{id_espacio:v,id_evento:l.id_evento,id_auth:n,fecha:new Date().toISOString(),creado_en:new Date().toISOString()}]).select().single();if(E)throw E;let{data:ve,error:I}=yield _.from("orden_pago").insert([{id_auth:n,id_evento:l.id_evento,id_espacio:v,monto:1500,estado:"pendiente",created_at:new Date().toISOString(),updated_at:new Date().toISOString()}]).select().single();if(I)throw I;let C=yield fetch(`${ce.supabaseUrl}/functions/v1/transbank-simular`,{method:"POST",headers:{"Content-Type":"application/json"},body:JSON.stringify({id_reserva:pe.id_reserva,monto:1500,descripcion:`Pago arriendo espacio #${v}`,return_url:"http://localhost:8100/pago-retorno"})});if(!C.ok)throw new Error("Error al iniciar simulaci\xF3n de pago");let b=yield C.json();if(b.url&&b.token)window.location.href=`${b.url}?token_ws=${b.token}`;else throw new Error("No se recibi\xF3 token o URL de Transbank.")}catch(l){console.error("Error al enviar solicitud:",l),this.mostrarAlerta("Error","No se pudo completar la reserva ni el pago.")}})}mostrarAlerta(t,r){return u(this,null,function*(){yield(yield this.alertCtrl.create({header:t,message:r,buttons:["OK"]})).present()})}mostrarToast(t){return u(this,null,function*(){(yield this.toastCtrl.create({message:t,duration:2500,color:"success"})).present()})}};a.\u0275fac=function(r){return new(r||a)(d(P),d(me),d(de),d(ae),d(se),d(T))},a.\u0275cmp=D({type:a,selectors:[["app-solicitud"]],decls:44,vars:5,consts:[[1,"rb-header"],["slot","start"],["menu","mainMenu","autoHide","false"],[1,"ion-padding","solicitud",3,"fullscreen"],[1,"card"],[3,"ngSubmit","formGroup"],[1,"field"],["position","stacked"],["formControlName","id_espacio","interface","popover","placeholder","Elige un espacio disponible"],[3,"value",4,"ngFor","ngForOf"],["color","medium",4,"ngIf"],["formControlName","descripcion","placeholder","Agrega una nota o detalle sobre la reserva (opcional)"],["formControlName","evento_titulo","placeholder","Ej: Campeonato de f\xFAtbol"],["formControlName","evento_descripcion","placeholder","Describe el evento"],["formControlName","evento_inicio","presentation","date-time","minute-values","0,15,30,45"],["formControlName","evento_fin","presentation","date-time","minute-values","0,15,30,45"],[1,"actions"],["expand","block","type","submit","color","success",3,"disabled"],[3,"value"],["color","medium"]],template:function(r,n){r&1&&(i(0,"ion-header",0)(1,"ion-toolbar")(2,"ion-buttons",1),p(3,"ion-menu-button",2),e(),i(4,"ion-title"),o(5,"Reserva de Espacio/Terreno"),e()()(),i(6,"ion-content",3)(7,"ion-card",4)(8,"ion-card-header")(9,"ion-card-title"),o(10,"Formulario de Reserva"),e(),i(11,"ion-card-subtitle"),o(12,"Completa los datos para solicitar un espacio"),e()(),i(13,"ion-card-content")(14,"form",5),w("ngSubmit",function(){return n.enviarSolicitud()}),i(15,"ion-item",6)(16,"ion-label",7),o(17,"Selecciona un Espacio"),e(),i(18,"ion-select",8),g(19,ue,2,3,"ion-select-option",9),e()(),g(20,fe,2,0,"ion-note",10),i(21,"ion-item",6)(22,"ion-label",7),o(23,"Descripci\xF3n / Comentario"),e(),p(24,"ion-textarea",11),e(),i(25,"ion-item",6)(26,"ion-label",7),o(27,"T\xEDtulo del Evento"),e(),p(28,"ion-input",12),e(),i(29,"ion-item",6)(30,"ion-label",7),o(31,"Descripci\xF3n del Evento"),e(),p(32,"ion-textarea",13),e(),i(33,"ion-item",6)(34,"ion-label"),o(35,"Fecha de Inicio"),e(),p(36,"ion-datetime",14),e(),i(37,"ion-item",6)(38,"ion-label"),o(39,"Fecha de T\xE9rmino"),e(),p(40,"ion-datetime",15),e(),i(41,"div",16)(42,"ion-button",17),o(43," \u{1F4B3} Reservar Espacio "),e()()()()()()),r&2&&(c(6),m("fullscreen",!0),c(8),m("formGroup",n.solicitudForm),c(5),m("ngForOf",n.espaciosDisponibles),c(),m("ngIf",n.espaciosDisponibles.length===0),c(22),m("disabled",n.solicitudForm.invalid))},dependencies:[x,F,N,le,$,G,V,H,U,L,J,K,z,Q,W,X,Y,Z,ee,te,ie,oe,ne,re,q,B,R,j,O,k,A,M],styles:["ion-toolbar[_ngcontent-%COMP%]{--background: #3880ff;--color: #fff}ion-button[_ngcontent-%COMP%]{margin-top:20px}"]});let s=a;return s})();export{Ne as SolicitudPage};
