import{a as fe}from"./chunk-CATCBSYX.js";import{a as ue}from"./chunk-GC4IB6VA.js";import{a as pe}from"./chunk-CL4KBMSP.js";import"./chunk-SIZNMXVG.js";import{a as _}from"./chunk-TX5AFJTF.js";import{a as me}from"./chunk-66QFWZLQ.js";import{A as o,D as F,Ea as G,Fa as V,Ga as H,Ha as L,Ia as U,Ja as J,Ka as K,Na as z,O as N,Oa as Q,P as x,Ra as W,S as T,Ua as X,Va as Y,Wa as Z,_ as O,_a as ee,ab as ie,ca as v,da as j,ea as k,gb as te,hb as oe,i as c,j as l,ja as A,k as D,kb as ne,la as M,lb as re,m as E,mb as ae,o as d,oa as P,p as t,q as e,r as m,rb as se,sa as B,sb as le,ua as R,ub as ce,v as y,vb as de,ya as q,za as $}from"./chunk-H7HGEQUX.js";import"./chunk-G4GOZ2R2.js";import"./chunk-2GHFZAQB.js";import"./chunk-QUJFQN2Y.js";import"./chunk-VBARJE22.js";import"./chunk-6T3MRKSY.js";import"./chunk-LG5HFCS7.js";import"./chunk-PTM2QU7L.js";import"./chunk-Z7QLWI7J.js";import"./chunk-DNXVUVY2.js";import"./chunk-JS56SECH.js";import"./chunk-GFYYGWWH.js";import"./chunk-EXVGCGBZ.js";import"./chunk-IACAUHTZ.js";import"./chunk-WIVIOYVM.js";import"./chunk-ULQSOQCK.js";import"./chunk-JOPIHTUJ.js";import"./chunk-MTHZ7MWU.js";import"./chunk-WI5MSH4N.js";import"./chunk-EKNMT7ZB.js";import"./chunk-CKP3SGE2.js";import"./chunk-K6CL52MX.js";import{j as f}from"./chunk-VI73JOY6.js";function he(s,a){if(s&1&&(t(0,"ion-select-option",18),o(1),e()),s&2){let S=a.$implicit;d("value",S.id_espacio),c(),F(" ",S.nombre," - ",S.tipo," ")}}function be(s,a){s&1&&(t(0,"ion-note",19),o(1," No hay espacios disponibles por ahora. "),e())}var je=(()=>{let a=class a{constructor(i,r,n,p,u,b,h){this.fb=i,this.espaciosService=r,this.authService=n,this.alertCtrl=p,this.toastCtrl=u,this.loadingCtrl=b,this.router=h,this.espaciosDisponibles=[],this.solicitudForm=this.fb.group({id_espacio:["",v.required],descripcion:[""],evento_titulo:["",v.required],evento_descripcion:["",v.required],evento_inicio:["",v.required],evento_fin:["",v.required]})}ngOnInit(){return f(this,null,function*(){yield this.cargarEspaciosDisponibles()})}cargarEspaciosDisponibles(){return f(this,null,function*(){try{let i=yield this.espaciosService.obtenerEspacios();this.espaciosDisponibles=i||[]}catch(i){console.error("Error cargando espacios:",i),this.espaciosDisponibles=[]}})}enviarSolicitud(){return f(this,null,function*(){if(this.solicitudForm.invalid)return;let i=this.solicitudForm.value,n=(yield this.authService.session())?.user?.id||null;if(!n){this.mostrarAlerta("Error","No se pudo obtener el usuario autenticado.");return}let p=yield this.loadingCtrl.create({message:"Procesando solicitud...",spinner:"crescent"});yield p.present();try{let{data:u,error:b}=yield _.from("evento").insert([{titulo:i.evento_titulo,descripcion:i.evento_descripcion,fecha_inicio:i.evento_inicio,fecha_fin:i.evento_fin}]).select().single();if(b)throw b;let h=Number(i.id_espacio),{data:ve,error:I}=yield _.from("reserva").insert([{id_espacio:h,id_evento:u.id_evento,id_auth:n,fecha:new Date().toISOString(),creado_en:new Date().toISOString()}]).select().single();if(I)throw I;let{data:ge,error:C}=yield _.from("orden_pago").insert([{id_auth:n,id_evento:u.id_evento,id_espacio:h,monto:1500,estado:"pendiente",created_at:new Date().toISOString(),updated_at:new Date().toISOString()}]).select().single();if(C)throw C;let w=yield fetch(`${me.supabaseUrl}/functions/v1/transbank-simular`,{method:"POST",headers:{"Content-Type":"application/json"},body:JSON.stringify({id_reserva:ve.id_reserva,monto:1500,descripcion:`Pago arriendo espacio #${h}`})});if(!w.ok)throw new Error("Error al iniciar simulaci\xF3n de pago");let g=yield w.json();if(g.url&&g.token)yield ue.open({url:`${g.url}?token_ws=${g.token}`,presentationStyle:"fullscreen"});else throw new Error("No se recibi\xF3 token o URL de Transbank.");yield p.dismiss()}catch(u){console.error("Error al enviar solicitud:",u),yield p.dismiss(),this.mostrarAlerta("Error","No se pudo completar la reserva ni el pago.")}})}mostrarAlerta(i,r){return f(this,null,function*(){yield(yield this.alertCtrl.create({header:i,message:r,buttons:["OK"]})).present()})}mostrarToast(i){return f(this,null,function*(){(yield this.toastCtrl.create({message:i,duration:2500,color:"success"})).present()})}};a.\u0275fac=function(r){return new(r||a)(l(B),l(fe),l(pe),l(se),l(ce),l(le),l(O))},a.\u0275cmp=D({type:a,selectors:[["app-solicitud"]],decls:44,vars:5,consts:[[1,"rb-header"],["slot","start"],["menu","mainMenu","autoHide","false"],[1,"ion-padding","solicitud",3,"fullscreen"],[1,"card"],[3,"ngSubmit","formGroup"],[1,"field"],["position","stacked"],["formControlName","id_espacio","interface","popover","placeholder","Elige un espacio disponible"],[3,"value",4,"ngFor","ngForOf"],["color","medium",4,"ngIf"],["formControlName","descripcion","placeholder","Agrega una nota o detalle sobre la reserva (opcional)"],["formControlName","evento_titulo","placeholder","Ej: Campeonato de f\xFAtbol"],["formControlName","evento_descripcion","placeholder","Describe el evento"],["formControlName","evento_inicio","presentation","date-time","minute-values","0,15,30,45"],["formControlName","evento_fin","presentation","date-time","minute-values","0,15,30,45"],[1,"actions"],["expand","block","type","submit","color","success",3,"disabled"],[3,"value"],["color","medium"]],template:function(r,n){r&1&&(t(0,"ion-header",0)(1,"ion-toolbar")(2,"ion-buttons",1),m(3,"ion-menu-button",2),e(),t(4,"ion-title"),o(5,"Reserva de Espacio/Terreno"),e()()(),t(6,"ion-content",3)(7,"ion-card",4)(8,"ion-card-header")(9,"ion-card-title"),o(10,"Formulario de Reserva"),e(),t(11,"ion-card-subtitle"),o(12,"Completa los datos para solicitar un espacio"),e()(),t(13,"ion-card-content")(14,"form",5),y("ngSubmit",function(){return n.enviarSolicitud()}),t(15,"ion-item",6)(16,"ion-label",7),o(17,"Selecciona un Espacio"),e(),t(18,"ion-select",8),E(19,he,2,3,"ion-select-option",9),e()(),E(20,be,2,0,"ion-note",10),t(21,"ion-item",6)(22,"ion-label",7),o(23,"Descripci\xF3n / Comentario"),e(),m(24,"ion-textarea",11),e(),t(25,"ion-item",6)(26,"ion-label",7),o(27,"T\xEDtulo del Evento"),e(),m(28,"ion-input",12),e(),t(29,"ion-item",6)(30,"ion-label",7),o(31,"Descripci\xF3n del Evento"),e(),m(32,"ion-textarea",13),e(),t(33,"ion-item",6)(34,"ion-label"),o(35,"Fecha de Inicio"),e(),m(36,"ion-datetime",14),e(),t(37,"ion-item",6)(38,"ion-label"),o(39,"Fecha de T\xE9rmino"),e(),m(40,"ion-datetime",15),e(),t(41,"div",16)(42,"ion-button",17),o(43," \u{1F4B3} Reservar Espacio "),e()()()()()()),r&2&&(c(6),d("fullscreen",!0),c(8),d("formGroup",n.solicitudForm),c(5),d("ngForOf",n.espaciosDisponibles),c(),d("ngIf",n.espaciosDisponibles.length===0),c(22),d("disabled",n.solicitudForm.invalid))},dependencies:[T,N,x,de,G,V,H,L,U,J,K,z,Q,W,X,Y,Z,ee,ie,te,oe,ne,re,ae,q,$,R,A,j,k,M,P],styles:["ion-toolbar[_ngcontent-%COMP%]{--background: #3880ff;--color: #fff}ion-button[_ngcontent-%COMP%]{margin-top:20px}"]});let s=a;return s})();export{je as SolicitudPage};
