import{a as S}from"./chunk-66QFWZLQ.js";import{A as l,B as x,C,Ea as A,Fa as D,Na as P,O as E,P as T,Ra as V,S as z,Va as k,Wa as F,Xa as N,f,g as h,i as c,ib as $,j as b,jb as O,k as w,lb as R,m as g,mb as U,o as d,p as s,q as n,r as v,rb as L,u as y,ub as M,v as I,vb as j,w as p,wb as q}from"./chunk-H7HGEQUX.js";import"./chunk-G4GOZ2R2.js";import"./chunk-2GHFZAQB.js";import"./chunk-QUJFQN2Y.js";import"./chunk-VBARJE22.js";import"./chunk-6T3MRKSY.js";import"./chunk-LG5HFCS7.js";import"./chunk-PTM2QU7L.js";import"./chunk-Z7QLWI7J.js";import"./chunk-DNXVUVY2.js";import"./chunk-JS56SECH.js";import"./chunk-GFYYGWWH.js";import"./chunk-EXVGCGBZ.js";import"./chunk-IACAUHTZ.js";import"./chunk-WIVIOYVM.js";import"./chunk-ULQSOQCK.js";import"./chunk-JOPIHTUJ.js";import"./chunk-MTHZ7MWU.js";import"./chunk-WI5MSH4N.js";import"./chunk-EKNMT7ZB.js";import"./chunk-CKP3SGE2.js";import"./chunk-K6CL52MX.js";import{j as m}from"./chunk-VI73JOY6.js";function B(i,a){i&1&&v(0,"ion-spinner",5)}function H(i,a){if(i&1&&(s(0,"p"),l(1),n()),i&2){let r=p().$implicit;c(),C("\u{1F3E0} ",r.direccion)}}function K(i,a){if(i&1){let r=y();s(0,"ion-item")(1,"ion-label")(2,"h2"),l(3),n(),s(4,"p"),l(5),n(),g(6,H,2,1,"p",3),n(),s(7,"ion-buttons",7)(8,"ion-button",8),I("click",function(){let e=f(r).$implicit,o=p(2);return h(o.cambiarEstado(e,"activo"))}),l(9," ACEPTAR "),n(),s(10,"ion-button",9),I("click",function(){let e=f(r).$implicit,o=p(2);return h(o.cambiarEstado(e,"rechazado"))}),l(11," RECHAZAR "),n()()()}if(i&2){let r=a.$implicit;c(3),x(r.nombre||"Sin nombre"),c(2),x(r.correo||"Sin correo"),c(),d("ngIf",r.direccion)}}function Z(i,a){if(i&1&&(s(0,"ion-list"),g(1,K,12,3,"ion-item",6),n()),i&2){let r=p();c(),d("ngForOf",r.solicitudes)}}function G(i,a){i&1&&(s(0,"ion-text",10)(1,"p",11),l(2,"No hay solicitudes pendientes"),n()())}var ie=(()=>{let a=class a{constructor(t,e){this.toastCtrl=t,this.alertCtrl=e,this.solicitudes=[],this.cargando=!1,this.supabase=q(S.supabaseUrl,S.supabaseAnonKey)}ngOnInit(){return m(this,null,function*(){yield this.cargarSolicitudes()})}cargarSolicitudes(){return m(this,null,function*(){this.cargando=!0;try{let{data:t,error:e}=yield this.supabase.from("usuario").select("*").eq("status","pendiente").order("creado_en",{ascending:!1});if(e)throw e;this.solicitudes=t||[],console.log("\u2705 Solicitudes cargadas:",this.solicitudes)}catch(t){console.error("\u274C Error al cargar solicitudes:",t.message),yield this.mostrarToast("Error al cargar las solicitudes.","danger")}finally{this.cargando=!1}})}cambiarEstado(t,e){return m(this,null,function*(){try{yield(yield this.alertCtrl.create({header:e==="activo"?"Aprobar registro":"Rechazar registro",message:e==="activo"?`\xBFDeseas aprobar a <b>${t.nombre||t.correo}</b> como vecino?`:`\xBFDeseas rechazar a <b>${t.nombre||t.correo}</b>?`,buttons:[{text:"Cancelar",role:"cancel"},{text:"Confirmar",handler:()=>m(this,null,function*(){console.log("\u{1F9E9} Usuario seleccionado:",t);let{data:_,error:u}=yield this.supabase.from("usuario").update({status:e,actualizado_en:new Date().toISOString()}).eq("id_usuario",t.id_usuario).select();if(console.log("\u{1F7E1} Update resultado:",{data:_,error:u}),u){console.error("\u274C Error Supabase al actualizar:",u),u.message?.toLowerCase().includes("row level security")?yield this.mostrarToast("No tienes permisos para aprobar o rechazar vecinos (RLS activo).","danger"):yield this.mostrarToast(u.message||"Error al actualizar el estado.","danger");return}if(!_||Array.isArray(_)&&_.length===0){console.warn("\u26A0\uFE0F No se actualiz\xF3 ninguna fila. Verifica permisos o ID."),yield this.mostrarToast("No se pudo actualizar el estado. Verifica permisos o ID.","warning");return}yield this.mostrarToast(e==="activo"?"\u2705 Usuario aprobado correctamente":"\u{1F6AB} Usuario rechazado",e==="activo"?"success":"medium"),yield this.cargarSolicitudes()})}]})).present()}catch(o){console.error("\u274C Error al cambiar estado:",o.message),yield this.mostrarToast("Error al actualizar el estado.","danger")}})}mostrarToast(t,e="success"){return m(this,null,function*(){yield(yield this.toastCtrl.create({message:t,duration:3e3,color:e,position:"top"})).present()})}};a.\u0275fac=function(e){return new(e||a)(b(M),b(L))},a.\u0275cmp=w({type:a,selectors:[["app-solicitudes"]],decls:8,vars:3,consts:[["color","primary"],[1,"ion-padding"],["name","crescent","class","ion-margin",4,"ngIf"],[4,"ngIf"],["color","medium",4,"ngIf"],["name","crescent",1,"ion-margin"],[4,"ngFor","ngForOf"],["slot","end"],["color","success",3,"click"],["color","danger",3,"click"],["color","medium"],[1,"ion-text-center"]],template:function(e,o){e&1&&(s(0,"ion-header")(1,"ion-toolbar",0)(2,"ion-title"),l(3,"Solicitudes de Vecinos"),n()()(),s(4,"ion-content",1),g(5,B,1,0,"ion-spinner",2)(6,Z,2,1,"ion-list",3)(7,G,3,0,"ion-text",4),n()),e&2&&(c(5),d("ngIf",o.cargando),c(),d("ngIf",!o.cargando&&o.solicitudes.length>0),c(),d("ngIf",!o.cargando&&o.solicitudes.length===0))},dependencies:[z,E,T,j,A,D,P,V,k,F,N,$,O,R,U],encapsulation:2});let i=a;return i})();export{ie as SolicitudesPage};
