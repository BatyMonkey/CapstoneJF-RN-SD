import{a as m,b as h,c as w}from"./chunk-IIFLUBAB.js";import{a as e}from"./chunk-TX5AFJTF.js";import{c as p}from"./chunk-H7HGEQUX.js";import{j as n}from"./chunk-VI73JOY6.js";var b=(()=>{let c=class c{constructor(){}pickPhoto(){return n(this,null,function*(){let o=yield w.getPhoto({quality:80,allowEditing:!1,source:m.Prompt,resultType:h.DataUrl});if(!o?.dataUrl)throw new Error("No se obtuvo imagen");let t=(o.format||"jpg").toLowerCase();return{blob:yield this.dataUrlToBlob(o.dataUrl,this.extToMime(t)),ext:t,previewDataUrl:o.dataUrl}})}uploadOptionImage(o,t,r){return n(this,null,function*(){let i=`${r||"admin"}/${Date.now()}.${t}`,{error:s}=yield e.storage.from("votaciones").upload(i,o,{contentType:o.type,upsert:!0});if(s)throw s;let{data:l}=e.storage.from("votaciones").getPublicUrl(i);return l.publicUrl})}dataUrlToBlob(o,t){return n(this,null,function*(){let i=yield(yield fetch(o)).arrayBuffer();return new Blob([i],{type:t})})}extToMime(o){return o==="png"?"image/png":o==="gif"?"image/gif":"image/jpeg"}obtenerVotacionConOpciones(o){return n(this,null,function*(){let[{data:t,error:r},{data:i,error:s}]=yield Promise.all([e.from("votaciones").select("*").eq("id",o).single(),e.from("opciones_votacion_conteo").select("*").eq("votacion_id",o).order("titulo",{ascending:!0})]);if(r)throw r;if(s)throw s;let l,{data:u}=yield e.auth.getUser();if(u.user){let{data:f}=yield e.from("votos").select("opcion_id").eq("votacion_id",o).eq("usuario_id",u.user.id).maybeSingle();f?.opcion_id&&(l=f.opcion_id)}return{votacion:t,opciones:i??[],miOpcionId:l}})}votar(o,t){return n(this,null,function*(){let{data:r}=yield e.auth.getUser();if(!r.user)throw new Error("Debes iniciar sesi\xF3n para votar");let{error:i}=yield e.from("votos").insert({votacion_id:o,opcion_id:t,usuario_id:r.user.id});if(i)throw i})}suscribirVotosInsertados(o,t){return e.channel(`votos-insert-${o}`).on("postgres_changes",{event:"INSERT",schema:"public",table:"votos",filter:`votacion_id=eq.${o}`},r=>t(r)).subscribe()}desuscribir(o){e.removeChannel(o)}listarVotacionesActivas(){return n(this,null,function*(){let{data:o,error:t}=yield e.from("votaciones").select("*").eq("estado","activa").order("fecha_fin",{ascending:!0});if(t)throw t;return o??[]})}listarVotacionesFinalizadas(){return n(this,null,function*(){let{data:o,error:t}=yield e.from("votaciones").select("*").eq("estado","finalizada").order("fecha_fin",{ascending:!1});if(t)throw t;return o||[]})}crearVotacionConOpciones(o){return n(this,null,function*(){let{data:{user:t},error:r}=yield e.auth.getUser();if(r)throw r;if(!t)throw new Error("Debes iniciar sesi\xF3n");let{data:i,error:s}=yield e.from("votaciones").insert([{titulo:o.titulo,descripcion:o.descripcion??null,fecha_inicio:o.fecha_inicio,fecha_fin:o.fecha_fin,creado_por:t.id}]).select("id").single();if(s)throw s;let l=i.id,u=o.opciones.map(a=>typeof a=="string"?{titulo:a.trim(),descripcion:null,image_url:null}:{titulo:(a.titulo??"").trim(),descripcion:a.descripcion??null,image_url:a.image_url??null}).filter(a=>a.titulo.length>0);if(u.length<2)throw new Error("Agrega al menos dos opciones");let{error:f}=yield e.from("opciones_votacion").insert(u.map(a=>({votacion_id:l,titulo:a.titulo,descripcion:a.descripcion,image_url:a.image_url})));if(f)throw f;return l})}};c.\u0275fac=function(t){return new(t||c)},c.\u0275prov=p({token:c,factory:c.\u0275fac,providedIn:"root"});let d=c;return d})();export{b as a};
